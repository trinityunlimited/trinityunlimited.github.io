<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeatherMatrix â€” Multi-Model Forecast Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0a0d12;
  --bg2:      #0f1318;
  --bg3:      #151b24;
  --panel:    #111820;
  --border:   #1e2d3d;
  --border2:  #243447;
  --amber:    #f0a500;
  --amber2:   #ffc94d;
  --amber-dim:rgba(240,165,0,0.12);
  --cyan:     #00d4e8;
  --green:    #3dd68c;
  --red:      #f25757;
  --blue:     #4da6ff;
  --purple:   #b97bff;
  --orange:   #ff7b45;
  --text:     #c8d8e8;
  --text-dim: #6a8099;
  --text-bright:#e8f4ff;
  --mono:'Share Tech Mono', monospace;
  --sans:'Barlow Condensed', sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:16px;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(30,45,61,.3) 1px,transparent 1px),linear-gradient(90deg,rgba(30,45,61,.3) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
.wrap{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:24px 20px 60px}

/* â”€â”€ HEADER â”€â”€ */
header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:baseline;gap:10px}
.logo-mark{font-family:var(--mono);font-size:11px;color:var(--amber);letter-spacing:.15em;padding:3px 8px;border:1px solid var(--amber);border-radius:2px;background:var(--amber-dim)}
.logo h1{font-family:var(--sans);font-size:36px;font-weight:700;letter-spacing:.05em;color:var(--text-bright);line-height:1}
.logo h1 span{color:var(--amber)}
.header-right{font-family:var(--mono);font-size:11px;color:var(--text-dim);text-align:right;line-height:1.8}
.header-right .live{color:var(--green)}

/* â”€â”€ CONTROLS â”€â”€ */
.controls{display:grid;grid-template-columns:1fr auto auto;gap:12px;margin-bottom:12px;align-items:end}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-family:var(--mono);font-size:10px;letter-spacing:.15em;color:var(--amber);text-transform:uppercase}
.field input,.field select{background:var(--panel);border:1px solid var(--border2);color:var(--text-bright);font-family:var(--sans);font-size:17px;font-weight:400;padding:10px 14px;border-radius:4px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
.field input:focus,.field select:focus{border-color:var(--amber);box-shadow:0 0 0 2px rgba(240,165,0,.12)}
.field input::placeholder{color:var(--text-dim)}
.field select option{background:var(--bg3);color:var(--text-bright)}
.btn-fetch{background:var(--amber);color:#0a0d12;border:none;font-family:var(--sans);font-size:17px;font-weight:700;letter-spacing:.08em;padding:10px 28px;border-radius:4px;cursor:pointer;transition:background .2s,transform .1s;white-space:nowrap;align-self:end}
.btn-fetch:hover{background:var(--amber2)}
.btn-fetch:active{transform:scale(.98)}
.btn-fetch:disabled{background:#4a3d0a;color:#7a6a2a;cursor:not-allowed}

/* â”€â”€ UNIT TOGGLE â”€â”€ */
.unit-toggle{display:flex;align-items:center;gap:8px;margin-bottom:16px;font-family:var(--mono);font-size:11px;color:var(--text-dim)}
.unit-btn{background:var(--panel);border:1px solid var(--border2);color:var(--text-dim);font-family:var(--mono);font-size:11px;padding:4px 12px;border-radius:3px;cursor:pointer;transition:all .15s}
.unit-btn.active{background:var(--amber-dim);border-color:var(--amber);color:var(--amber)}

/* â”€â”€ STATUS â”€â”€ */
#status-bar{font-family:var(--mono);font-size:12px;color:var(--text-dim);padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:16px;min-height:34px;display:flex;align-items:center;gap:8px}
#status-bar .dot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
#status-bar.loading .dot{background:var(--amber);animation:blink .8s infinite}
#status-bar.success .dot{background:var(--green)}
#status-bar.error   .dot{background:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ LOCATION SUGGEST â”€â”€ */
.location-wrapper{position:relative}
#suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;z-index:100;max-height:220px;overflow-y:auto;display:none}
#suggestions.open{display:block}
.suggestion-item{padding:9px 14px;cursor:pointer;font-size:15px;transition:background .15s;border-bottom:1px solid var(--border)}
.suggestion-item:last-child{border-bottom:none}
.suggestion-item:hover{background:var(--border)}
.suggestion-item .sub{color:var(--text-dim);font-size:13px;margin-left:6px}

/* â”€â”€ PROGRESS PILLS â”€â”€ */
#progress-wrap{margin-bottom:20px;display:none}
#progress-wrap.visible{display:block}
.progress-models{display:flex;flex-wrap:wrap;gap:8px}
.model-pill{font-family:var(--mono);font-size:10px;padding:4px 10px;border-radius:2px;border:1px solid var(--border2);color:var(--text-dim);background:var(--bg3);transition:all .3s;letter-spacing:.05em}
.model-pill.loading{border-color:var(--amber);color:var(--amber);background:var(--amber-dim)}
.model-pill.success{border-color:var(--green);color:var(--green);background:rgba(61,214,140,.1)}
.model-pill.failed{border-color:var(--border);color:#3a4a5a;text-decoration:line-through}

/* â”€â”€ RESULTS â”€â”€ */
#results{display:none}
#results.visible{display:block;animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* â”€â”€ NARRATIVE SUMMARY â”€â”€ */
.narrative-box{background:var(--panel);border:1px solid var(--border2);border-left:3px solid var(--amber);border-radius:6px;padding:20px 24px;margin-bottom:24px;display:flex;gap:18px;align-items:flex-start}
.narrative-icon{font-size:28px;line-height:1;flex-shrink:0;margin-top:2px}
.narrative-body{}
.narrative-title{font-family:var(--mono);font-size:10px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:8px}
.narrative-text{font-size:19px;font-weight:400;color:var(--text-bright);line-height:1.5;margin-bottom:8px}
.narrative-detail{font-family:var(--mono);font-size:12px;color:var(--text-dim);line-height:1.7}
.narrative-detail span{color:var(--text);margin-right:16px}
.narrative-warn{color:var(--red);font-family:var(--mono);font-size:11px;margin-top:6px}

/* â”€â”€ STAT CARDS â”€â”€ */
.stat-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:14px 16px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.st-hi::before  {background:var(--amber)}
.stat-card.st-lo::before  {background:var(--cyan)}
.stat-card.st-pr::before  {background:var(--blue)}
.stat-card.st-wi::before  {background:var(--green)}
.stat-card.st-hu::before  {background:var(--purple)}
.sc-label{font-family:var(--mono);font-size:9px;letter-spacing:.2em;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px}
.sc-val{font-family:var(--mono);font-size:26px;color:var(--text-bright);line-height:1}
.sc-val .u{font-size:14px;color:var(--text-dim);margin-left:2px}
.sc-range{font-family:var(--mono);font-size:11px;color:var(--text-dim);margin-top:4px}
.sc-agree{font-family:var(--mono);font-size:10px;margin-top:5px}
.agree-low {color:var(--green)}
.agree-med {color:var(--amber)}
.agree-high{color:var(--red)}

/* â”€â”€ STRIP CHART (consensus visualizer) â”€â”€ */
.strip-section{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:20px 24px;margin-bottom:24px}
.strip-section-title{font-family:var(--mono);font-size:11px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:6px}
.strip-section-sub{font-family:var(--mono);font-size:11px;color:var(--text-dim);margin-bottom:20px}
.strip-block{margin-bottom:20px}
.strip-block:last-child{margin-bottom:0}
.strip-metric-label{font-family:var(--mono);font-size:10px;letter-spacing:.15em;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.strip-consensus-tag{font-size:9px;padding:2px 7px;border-radius:2px;letter-spacing:.1em}
.tag-hi  {background:rgba(61,214,140,.15); color:var(--green); border:1px solid rgba(61,214,140,.3)}
.tag-med {background:rgba(240,165,0,.12);  color:var(--amber); border:1px solid rgba(240,165,0,.3)}
.tag-lo  {background:rgba(242,87,87,.12);  color:var(--red);   border:1px solid rgba(242,87,87,.3)}
.strip-svg-wrap{width:100%;overflow:visible;margin-bottom:2px}
.strip-axis-labels{display:flex;justify-content:space-between;padding:0 2%;font-family:var(--mono);font-size:10px;color:var(--text-dim)}
.strip-axis-labels .ax-avg{color:var(--amber)}
.strip-divider{border:none;border-top:1px solid var(--border);margin:16px 0}

/* â”€â”€ AGREEMENT MATRIX â”€â”€ */
.agree-section{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:20px 24px;margin-bottom:24px}
.agree-section h3{font-family:var(--mono);font-size:11px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:16px}
.agree-grid{display:grid;grid-template-columns:180px repeat(5,1fr);gap:0}
.ag-header,.ag-cell,.ag-row-label{font-family:var(--mono);font-size:10px;padding:8px 10px;border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
.ag-header{color:var(--text-dim);text-align:center;letter-spacing:.1em;text-transform:uppercase;background:var(--bg2);font-size:9px}
.ag-row-label{color:var(--text-bright);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-right:1px solid var(--border2)}
.ag-cell{text-align:center;font-size:12px;position:relative;transition:background .2s}
.ag-cell .cv{font-size:13px;font-weight:400;color:var(--text-bright)}
.ag-cell .cd{font-size:10px;color:var(--text-dim);margin-top:1px}
.ag-footer{background:var(--bg2);border-top:2px solid var(--border2)}
.ag-footer .cv{color:var(--amber)}
.deviation-low {background:rgba(61,214,140,.08)}
.deviation-med {background:rgba(240,165,0,.08)}
.deviation-high{background:rgba(242,87,87,.1)}
.deviation-none{background:transparent}
.outlier-flag{position:absolute;top:3px;right:3px;width:5px;height:5px;border-radius:50%;background:var(--red)}

/* â”€â”€ CHARTS â”€â”€ */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:18px 20px}
.chart-panel h3{font-family:var(--mono);font-size:11px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:6px}
.chart-sub{font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:14px}
.chart-container{position:relative;height:220px}
.full-chart-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:24px}
.full-chart-panel h3{font-family:var(--mono);font-size:11px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:6px}
.full-chart-container{position:relative;height:260px}

/* â”€â”€ TABLE â”€â”€ */
.table-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:20px;margin-bottom:24px;overflow-x:auto}
.table-panel h3{font-family:var(--mono);font-size:11px;letter-spacing:.2em;color:var(--amber);text-transform:uppercase;margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{font-family:var(--mono);font-size:10px;letter-spacing:.12em;color:var(--text-dim);text-transform:uppercase;text-align:left;padding:8px 12px;border-bottom:1px solid var(--border2);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s}
tbody tr:hover{background:rgba(255,255,255,.03)}
tbody tr:last-child{border-bottom:none}
tbody td{padding:10px 12px;white-space:nowrap}
.td-model-name{font-weight:600;color:var(--text-bright);font-size:15px}
.td-model-origin{font-family:var(--mono);font-size:10px;color:var(--text-dim);display:block;margin-top:1px}
.v-hi{color:var(--amber);font-family:var(--mono);font-size:15px}
.v-lo{color:var(--cyan);font-family:var(--mono);font-size:15px}
.v-pr{color:var(--blue);font-family:var(--mono);font-size:15px}
.v-wi{color:var(--green);font-family:var(--mono);font-size:15px}
.v-hu{color:var(--purple);font-family:var(--mono);font-size:15px}
.v-cl{color:#aaa;font-family:var(--mono);font-size:15px}
.v-uv{color:var(--orange);font-family:var(--mono);font-size:15px}
.outlier-cell{background:rgba(242,87,87,.08);color:var(--red)!important}

/* â”€â”€ FOOTER â”€â”€ */
footer{border-top:1px solid var(--border);padding-top:20px;margin-top:8px;display:flex;justify-content:space-between;align-items:flex-start;gap:20px}
footer p{font-family:var(--mono);font-size:11px;color:var(--text-dim);line-height:1.7}
footer a{color:var(--amber);text-decoration:none}
.model-legend{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
.legend-tag{font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:2px;background:var(--bg3);border:1px solid var(--border2);color:var(--text-dim)}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:900px){
  .stat-row{grid-template-columns:repeat(3,1fr)}
  .charts-row{grid-template-columns:1fr}
  .controls{grid-template-columns:1fr 1fr}
  .btn-fetch{grid-column:1/-1}
  header{flex-direction:column;align-items:flex-start;gap:12px}
  .agree-grid{grid-template-columns:120px repeat(5,1fr)}
}
@media(max-width:560px){
  .stat-row{grid-template-columns:1fr 1fr}
  .agree-grid{grid-template-columns:100px repeat(5,1fr);font-size:9px}
}
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header>
  <div class="logo">
    <span class="logo-mark">v3.0</span>
    <h1>Weather<span>Matrix</span></h1>
  </div>
  <div class="header-right">
    <span class="live">â— LIVE DATA</span> â€” OPEN METEOROLOGICAL MODELS<br>
    12 INDEPENDENT FORECAST SOURCES â€” NO SIGN-UP REQUIRED<br>
    HRRR Â· GFS Â· NAM Â· NBM Â· ECMWF Â· ICON Â· GEM Â· MORE
  </div>
</header>

<!-- CONTROLS -->
<div class="controls">
  <div class="field">
    <label>Location</label>
    <div class="location-wrapper">
      <input type="text" id="location-input" placeholder="City, state, or ZIP codeâ€¦" autocomplete="off" spellcheck="false"/>
      <div id="suggestions"></div>
    </div>
  </div>
  <div class="field">
    <label>Forecast Day</label>
    <select id="day-select"></select>
  </div>
  <button class="btn-fetch" id="fetch-btn" onclick="fetchAllModels()">RUN ANALYSIS</button>
</div>

<div class="unit-toggle">
  UNITS:
  <button class="unit-btn active" id="btn-imperial" onclick="setUnits('imperial')">Â°F / mph / in</button>
  <button class="unit-btn"        id="btn-metric"   onclick="setUnits('metric')">Â°C / km/h / mm</button>
</div>

<div id="status-bar">
  <div class="dot"></div>
  <span id="status-text">Enter a location and select a day to begin.</span>
</div>

<div id="progress-wrap">
  <div class="progress-models" id="progress-pills"></div>
</div>

<!-- RESULTS -->
<div id="results">

  <!-- NARRATIVE -->
  <div class="narrative-box">
    <div class="narrative-icon" id="narrative-icon">â›…</div>
    <div class="narrative-body">
      <div class="narrative-title">Forecast Summary</div>
      <div class="narrative-text" id="narrative-text">â€”</div>
      <div class="narrative-detail" id="narrative-detail">â€”</div>
      <div class="narrative-warn" id="narrative-warn"></div>
    </div>
  </div>

  <!-- STAT CARDS -->
  <div class="stat-row">
    <div class="stat-card st-hi">
      <div class="sc-label">Avg High Temp</div>
      <div class="sc-val" id="s-high">--<span class="u" id="u-hi">Â°F</span></div>
      <div class="sc-range" id="s-high-range">Range: --</div>
      <div class="sc-agree" id="s-high-agree">â€”</div>
    </div>
    <div class="stat-card st-lo">
      <div class="sc-label">Avg Low Temp</div>
      <div class="sc-val" id="s-low">--<span class="u" id="u-lo">Â°F</span></div>
      <div class="sc-range" id="s-low-range">Range: --</div>
      <div class="sc-agree" id="s-low-agree">â€”</div>
    </div>
    <div class="stat-card st-pr">
      <div class="sc-label">Avg Precip Chance</div>
      <div class="sc-val" id="s-precip">--<span class="u">%</span></div>
      <div class="sc-range" id="s-precip-range">Range: --</div>
      <div class="sc-agree" id="s-precip-agree">â€”</div>
    </div>
    <div class="stat-card st-wi">
      <div class="sc-label">Avg Wind Speed</div>
      <div class="sc-val" id="s-wind">--<span class="u" id="u-wi">mph</span></div>
      <div class="sc-range" id="s-wind-range">Range: --</div>
      <div class="sc-agree" id="s-wind-agree">â€”</div>
    </div>
    <div class="stat-card st-hu">
      <div class="sc-label">Avg Humidity</div>
      <div class="sc-val" id="s-humidity">--<span class="u">%</span></div>
      <div class="sc-range" id="s-humidity-range">Range: --</div>
      <div class="sc-agree" id="s-humidity-agree">â€”</div>
    </div>
  </div>

  <!-- CONSENSUS STRIP CHARTS -->
  <div class="strip-section">
    <div class="strip-section-title">Model Spread Visualization</div>
    <div class="strip-section-sub">Each dot is one forecast model. The <span style="color:var(--amber)">dashed line</span> is the average. The <span style="color:rgba(240,165,0,0.6)">shaded band</span> is the zone where the middle 50% of models cluster â€” tighter bands = higher confidence.</div>
    <div id="strip-charts"></div>
  </div>

  <!-- CONSENSUS AGREEMENT MATRIX -->
  <div class="agree-section">
    <h3>Model Agreement Matrix</h3>
    <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);margin-bottom:16px">
      Each cell shows how far that model's value deviates from the average. <span style="color:var(--green)">Green</span> = close to consensus. <span style="color:var(--amber)">Amber</span> = moderate deviation. <span style="color:var(--red)">Red</span> = outlier. Bottom row shows the consensus value across all models.
    </div>
    <div style="overflow-x:auto">
      <div class="agree-grid" id="agree-grid"></div>
    </div>
  </div>

  <!-- CHARTS ROW -->
  <div class="charts-row">
    <div class="chart-panel">
      <h3 id="title-temp">Temperature Range per Model (Â°F)</h3>
      <div class="chart-sub">Floating bar shows each model's low â†’ high. Orange line = average high across all models.</div>
      <div class="chart-container"><canvas id="temp-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <h3>Precipitation Probability per Model (%)</h3>
      <div class="chart-sub">Bars show each model's rain probability. Dashed line = 50% threshold. Solid line = average.</div>
      <div class="chart-container"><canvas id="precip-chart"></canvas></div>
    </div>
  </div>

  <div class="full-chart-panel">
    <h3 id="title-wind">Wind Speed &amp; Gusts â€” All Models</h3>
    <div class="chart-sub" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:14px">Green bars = sustained wind. Red bars = gusts. Lines show averages across all models.</div>
    <div class="full-chart-container"><canvas id="wind-chart"></canvas></div>
  </div>

  <!-- DATA TABLE -->
  <div class="table-panel">
    <h3>Full Raw Data â€” All Models</h3>
    <table>
      <thead>
        <tr>
          <th>Model</th>
          <th id="th-hi">High Â°F</th>
          <th id="th-lo">Low Â°F</th>
          <th>Precip %</th>
          <th id="th-ps">Precip (in)</th>
          <th id="th-wi">Wind (mph)</th>
          <th id="th-gu">Gusts (mph)</th>
          <th>Humidity %</th>
          <th>Cloud %</th>
          <th>UV Index</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div><!-- #results -->

<footer>
  <p>
    Data from <a href="https://open-meteo.com" target="_blank">Open-Meteo</a> â€” free, open-source, no API key needed.<br>
    US-priority models: HRRR (hourly hi-res), NAM CONUS, NBM (Natl Blend), GFS 0.25Â°.<br>
    Global models: ECMWF IFS, DWD ICON, Env. Canada GEM, JMA MSM, MÃ©tÃ©o-France.
  </p>
  <div class="model-legend">
    <span class="legend-tag">HRRR Â· USA</span>
    <span class="legend-tag">GFS Â· USA</span>
    <span class="legend-tag">NAM Â· USA</span>
    <span class="legend-tag">NBM Â· USA</span>
    <span class="legend-tag">ECMWF Â· EU</span>
    <span class="legend-tag">ICON Â· DE</span>
    <span class="legend-tag">GEM Â· CA</span>
    <span class="legend-tag">JMA Â· JP</span>
    <span class="legend-tag">AROME Â· FR</span>
    <span class="legend-tag">BEST-MATCH</span>
  </div>
</footer>

</div><!-- .wrap -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODEL REGISTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODELS = [
  { id:'best_match',           name:'Best-Match',       origin:'Auto-selected best available',    color:'#f0a500' },
  { id:'gfs_seamless',         name:'NOAA GFS',         origin:'Natl Weather Service, USA',        color:'#3dd68c' },
  { id:'gfs025',               name:'GFS 0.25Â°',        origin:'Natl Weather Service (hi-res)',    color:'#5debb0' },
  { id:'hrrr_conus',           name:'NOAA HRRR',        origin:'High-Res Rapid Refresh, USA',      color:'#ff7b45' },
  { id:'ncep_nbm_conus',       name:'NCEP NBM',         origin:'National Blend of Models, USA',    color:'#ffb347' },
  { id:'nam_conus',            name:'NOAA NAM',         origin:'North American Mesoscale, USA',    color:'#ff4d8b' },
  { id:'ecmwf_ifs04',          name:'ECMWF IFS',        origin:'European Centre for MWF, EU',      color:'#00d4e8' },
  { id:'ecmwf_ifs025',         name:'ECMWF 0.25Â°',      origin:'European Centre (hi-res)',         color:'#5bc8f5' },
  { id:'icon_seamless',        name:'DWD ICON',         origin:'Deutscher Wetterdienst, Germany',  color:'#4da6ff' },
  { id:'gem_seamless',         name:'Env. Canada GEM',  origin:'Environment Canada',               color:'#b97bff' },
  { id:'meteofrance_seamless', name:'MÃ©tÃ©o-France',     origin:'MÃ©tÃ©o-France AROME/ARPEGE',        color:'#f25757' },
  { id:'jma_seamless',         name:'JMA MSM',          origin:'Japan Met Agency',                 color:'#a8e063' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selLat=null, selLon=null, selName='';
let units='imperial';
let lastResults=[];
let chartTemp=null, chartPrecip=null, chartWind=null;
let geoTimer=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAY SELECT INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DNAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MNAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

(function initDays(){
  const sel=document.getElementById('day-select');
  for(let i=0;i<7;i++){
    const d=new Date(); d.setDate(d.getDate()+i);
    const lbl=i===0?`Today â€” ${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`
             :i===1?`Tomorrow â€” ${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`
             :`${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`;
    const o=document.createElement('option'); o.value=i; o.textContent=lbl; sel.appendChild(o);
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUnits(u){
  units=u;
  document.getElementById('btn-imperial').classList.toggle('active',u==='imperial');
  document.getElementById('btn-metric').classList.toggle('active',u==='metric');
  if(lastResults.length) renderResults(lastResults);
}
function conv(v,type){
  if(v==null) return null;
  if(units==='imperial'){
    if(type==='temp')   return v*9/5+32;
    if(type==='wind')   return v*0.621371;
    if(type==='precip') return v*0.0393701;
  }
  return v;
}
function ul(type){
  if(type==='temp')   return units==='imperial'?'Â°F':'Â°C';
  if(type==='wind')   return units==='imperial'?'mph':'km/h';
  if(type==='precip') return units==='imperial'?'in':'mm';
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEOCODING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const locInput=document.getElementById('location-input');
const suggBox=document.getElementById('suggestions');

locInput.addEventListener('input',()=>{
  clearTimeout(geoTimer);
  const q=locInput.value.trim();
  if(q.length<2){suggBox.classList.remove('open');return;}
  geoTimer=setTimeout(()=>doGeoSuggest(q),350);
});
locInput.addEventListener('blur',()=>setTimeout(()=>suggBox.classList.remove('open'),200));
locInput.addEventListener('keydown',e=>{if(e.key==='Enter'){suggBox.classList.remove('open');fetchAllModels();}});

async function doGeoSuggest(q){
  try{
    let res=await geoSearch(q,'US');
    if(!res.length) res=await geoSearch(q,'');
    if(!res.length){suggBox.classList.remove('open');return;}
    suggBox.innerHTML='';
    res.slice(0,6).forEach(r=>{
      const d=document.createElement('div');
      d.className='suggestion-item';
      d.innerHTML=`<strong>${r.name}</strong><span class="sub">${[r.admin1,r.country].filter(Boolean).join(', ')}</span>`;
      d.addEventListener('mousedown',()=>{
        selLat=r.latitude; selLon=r.longitude;
        selName=[r.name,r.admin1,r.country].filter(Boolean).join(', ');
        locInput.value=selName; suggBox.classList.remove('open');
      });
      suggBox.appendChild(d);
    });
    suggBox.classList.add('open');
  }catch(_){suggBox.classList.remove('open');}
}

async function geoSearch(q,cc){
  const ccp=cc?`&countryCode=${cc}`:'';
  const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=en&format=json${ccp}`);
  const d=await r.json(); return d.results||[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS / PILLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(msg,type=''){
  document.getElementById('status-bar').className=type;
  document.getElementById('status-text').textContent=msg;
}
function initPills(){
  const box=document.getElementById('progress-pills');
  box.innerHTML='';
  document.getElementById('progress-wrap').classList.add('visible');
  MODELS.forEach(m=>{
    const el=document.createElement('div');
    el.className='model-pill loading'; el.id=`pill-${m.id}`; el.textContent=m.name;
    box.appendChild(el);
  });
}
function setPill(id,state){const el=document.getElementById(`pill-${id}`);if(el) el.className=`model-pill ${state}`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllModels(){
  if(!selLat||!selLon||locInput.value!==selName){
    const q=locInput.value.trim();
    if(!q){setStatus('Please enter a location first.','error');return;}
    setStatus('Resolving locationâ€¦','loading');
    try{
      let res=await geoSearch(q,'US');
      if(!res.length) res=await geoSearch(q,'');
      if(!res.length){setStatus(`Could not find "${q}". Try a city name or ZIP code.`,'error');return;}
      selLat=res[0].latitude; selLon=res[0].longitude;
      selName=[res[0].name,res[0].admin1,res[0].country].filter(Boolean).join(', ');
      locInput.value=selName;
    }catch(e){setStatus('Network error. Check your internet connection.','error');return;}
  }

  const btn=document.getElementById('fetch-btn');
  btn.disabled=true;
  initPills();

  const dayOff=parseInt(document.getElementById('day-select').value);
  const target=new Date(); target.setDate(target.getDate()+dayOff);
  const dateStr=target.toISOString().split('T')[0];

  setStatus(`Querying ${MODELS.length} forecast models for ${selName}â€¦`,'loading');

  const CORE='temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,windspeed_10m_max,windgusts_10m_max,uv_index_max';
  const EXTRA='cloudcover_mean,relative_humidity_2m_mean';

  const results=[];

  await Promise.all(MODELS.map(async model=>{
    try{
      const resp=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${selLat}&longitude=${selLon}&daily=${CORE}&timezone=auto&models=${model.id}&forecast_days=8`);
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data=await resp.json();
      if(!data.daily?.time) throw new Error('No data');
      const di=data.daily.time.indexOf(dateStr);
      if(di===-1) throw new Error('Date not found');

      const row={
        model,
        high:      data.daily.temperature_2m_max?.[di]??null,
        low:       data.daily.temperature_2m_min?.[di]??null,
        precipProb:data.daily.precipitation_probability_max?.[di]??null,
        precipSum: data.daily.precipitation_sum?.[di]??null,
        wind:      data.daily.windspeed_10m_max?.[di]??null,
        gusts:     data.daily.windgusts_10m_max?.[di]??null,
        uv:        data.daily.uv_index_max?.[di]??null,
        humidity:null, cloud:null,
      };

      try{
        const er=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${selLat}&longitude=${selLon}&daily=${EXTRA}&timezone=auto&models=${model.id}&forecast_days=8`);
        if(er.ok){
          const ed=await er.json();
          if(ed.daily?.time){
            const ei=ed.daily.time.indexOf(dateStr);
            if(ei!==-1){
              row.humidity=ed.daily.relative_humidity_2m_mean?.[ei]??null;
              row.cloud   =ed.daily.cloudcover_mean?.[ei]??null;
            }
          }
        }
      }catch(_){}

      results.push(row);
      setPill(model.id,'success');
    }catch(_){setPill(model.id,'failed');}
  }));

  btn.disabled=false;

  if(!results.length){
    setStatus('All model requests failed. Please check your internet connection and try again.','error');
    return;
  }

  const dLbl=dayOff===0?'Today':dayOff===1?'Tomorrow':`${DNAMES[target.getDay()]} ${target.getDate()} ${MNAMES[target.getMonth()]}`;
  setStatus(`âœ“ ${results.length} of ${MODELS.length} models returned data â€” ${selName} â€” ${dLbl}`,'success');

  lastResults=results;
  renderResults(results);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATH HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const avg   = a=>{const v=a.filter(x=>x!=null);return v.length?v.reduce((s,x)=>s+x,0)/v.length:null};
const vmin  = a=>{const v=a.filter(x=>x!=null);return v.length?Math.min(...v):null};
const vmax  = a=>{const v=a.filter(x=>x!=null);return v.length?Math.max(...v):null};
const sprd  = a=>{const lo=vmin(a),hi=vmax(a);return lo==null?null:hi-lo};
const stdDev= a=>{const v=a.filter(x=>x!=null);if(!v.length)return null;const m=avg(v);return Math.sqrt(v.reduce((s,x)=>s+(x-m)**2,0)/v.length)};
const pct   = (v,lo,hi)=>Math.max(2,Math.min(98,((v-lo)/(hi-lo))*96+2));
const fmt   = (v,d=1)=>v==null?'â€”':(+v).toFixed(d);
const fmtV  = (v,type,d=0)=>v==null?'â€”':fmt(conv(v,type),d);

function scls(spread,lo,hi){
  if(spread==null) return '';
  return spread<=lo?'agree-low':spread<=hi?'agree-med':'agree-high';
}
function sclsLabel(spread,lo,hi){
  if(spread==null) return 'â€”';
  return spread<=lo?'HIGH AGREEMENT':spread<=hi?'MODERATE AGREEMENT':'LOW AGREEMENT';
}

function quartiles(arr){
  const v=[...arr.filter(x=>x!=null)].sort((a,b)=>a-b);
  if(!v.length) return {q1:null,median:null,q3:null};
  const q1=v[Math.floor(v.length*0.25)];
  const q3=v[Math.floor(v.length*0.75)];
  const med=v[Math.floor(v.length*0.5)];
  return {q1,median:med,q3};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NARRATIVE GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateNarrative(results){
  const highs=results.map(r=>r.high).filter(x=>x!=null);
  const lows =results.map(r=>r.low).filter(x=>x!=null);
  const probs=results.map(r=>r.precipProb).filter(x=>x!=null);
  const winds=results.map(r=>r.wind).filter(x=>x!=null);
  const hums =results.map(r=>r.humidity).filter(x=>x!=null);
  const clouds=results.map(r=>r.cloud).filter(x=>x!=null);

  const avgH=avg(highs), avgL=avg(lows), avgP=avg(probs), avgW=avg(winds);
  const tU=ul('temp'), wU=ul('wind');

  const dH=conv(avgH,'temp'), dL=conv(avgL,'temp'), dW=conv(avgW,'wind');

  // Temperature feel
  let feel='', icon='ğŸŒ¤';
  const iF=units==='imperial';
  if(dH==null){feel='unknown temperature';}
  else if(dH>(iF?95:35)){feel='dangerously hot';icon='ğŸ”¥';}
  else if(dH>(iF?85:30)){feel='very hot';icon='â˜€ï¸';}
  else if(dH>(iF?75:24)){feel='warm and sunny';icon='ğŸŒ';}
  else if(dH>(iF?65:18)){feel='mild';icon='ğŸŒ¤';}
  else if(dH>(iF?50:10)){feel='cool';icon='ğŸŒ¥';}
  else if(dH>(iF?32:0)){feel='cold';icon='ğŸ§¥';}
  else{feel='freezing';icon='â„ï¸';}

  // Rain assessment
  const rainYes=probs.filter(p=>p>=50).length;
  const rainPct=probs.length?Math.round(rainYes/probs.length*100):0;
  let rainText='';
  if(avgP==null){rainText='precipitation data unavailable';}
  else if(avgP>=70){rainText='rain is very likely';icon=icon==='ğŸŒ'?'ğŸŒ§':icon;}
  else if(avgP>=50){rainText='rain is probable';icon='ğŸŒ¦';}
  else if(avgP>=30){rainText='some chance of rain';icon=icon==='â˜€ï¸'?'â›…':icon;}
  else if(avgP>=10){rainText='rain is unlikely';}
  else{rainText='dry conditions expected';}

  // Model agreement
  const tSpread=sprd(highs.map(v=>conv(v,'temp')));
  const lo=iF?5:3, hi=iF?12:7;
  let agreeText='';
  if(tSpread==null){agreeText='';}
  else if(tSpread<=lo){agreeText='Models show strong agreement on this forecast.';}
  else if(tSpread<=hi){agreeText='Models are mostly in agreement â€” minor uncertainty.';}
  else{agreeText=`âš  Models disagree on temperature by ${fmt(tSpread,0)}${tU} â€” treat with caution.`;}

  // Main sentence
  const hiStr=dH!=null?`${fmt(dH,iF?0:1)}${tU}`:'--';
  const loStr=dL!=null?`${fmt(dL,iF?0:1)}${tU}`:'--';
  const wiStr=dW!=null?`${fmt(dW,iF?0:1)} ${wU}`:'--';
  const prStr=avgP!=null?`${fmt(avgP,0)}%`:'--';

  const text=`A ${feel} day â€” highs around ${hiStr}, lows near ${loStr}. ${rainText.charAt(0).toUpperCase()+rainText.slice(1)}.`;

  // Detail line
  const parts=[];
  if(avgW!=null) parts.push(`Wind ${wiStr}`);
  if(avgP!=null) parts.push(`${prStr} avg precip chance`);
  if(hums.length) parts.push(`~${fmt(avg(hums),0)}% humidity`);
  if(clouds.length) parts.push(`~${fmt(avg(clouds),0)}% cloud cover`);
  parts.push(`${results.length} models queried`);

  return {icon, text, detail:parts.map(p=>`<span>${p}</span>`).join(''), warn:agreeText.startsWith('âš ')?agreeText:''};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRIP CHART (SVG DOT PLOT)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildStripChart(values, modelColors, modelNames, labelText, unit, decimals){
  const valid=values.filter((_,i)=>values[i]!=null);
  if(!valid.length) return '';

  const lo=vmin(values), hi=vmax(values);
  const range=hi-lo||1;
  // Pad range 10% each side
  const pad=range*0.1;
  const axMin=lo-pad, axMax=hi+pad;
  const axRange=axMax-axMin;

  const {q1,q3}=quartiles(values);
  const mean=avg(values);

  const q1Pct =q1!=null?((q1-axMin)/axRange)*96+2:null;
  const q3Pct =q3!=null?((q3-axMin)/axRange)*96+2:null;
  const mPct  =mean!=null?((mean-axMin)/axRange)*96+2:null;
  const loPct =((lo-axMin)/axRange)*96+2;
  const hiPct =((hi-axMin)/axRange)*96+2;

  // Spread assessment
  const spread=hi-lo;
  const iF=units==='imperial';
  let spreadClass='tag-hi', spreadLabel='HIGH CONSENSUS';
  if(unit===ul('temp')){
    if(spread>(iF?10:6)){spreadClass='tag-lo';spreadLabel='LOW CONSENSUS';}
    else if(spread>(iF?4:2)){spreadClass='tag-med';spreadLabel='MODERATE CONSENSUS';}
  } else if(unit==='%'){
    if(spread>35){spreadClass='tag-lo';spreadLabel='LOW CONSENSUS';}
    else if(spread>15){spreadClass='tag-med';spreadLabel='MODERATE CONSENSUS';}
  } else {
    if(spread>(iF?12:20)){spreadClass='tag-lo';spreadLabel='LOW CONSENSUS';}
    else if(spread>(iF?5:8)){spreadClass='tag-med';spreadLabel='MODERATE CONSENSUS';}
  }

  // Build dots â€” jitter Y slightly to separate overlapping values
  const dots=[];
  const sortedIdx=[...values.keys()].filter(i=>values[i]!=null).sort((a,b)=>values[a]-values[b]);
  sortedIdx.forEach((i,rank)=>{
    const v=values[i];
    const x=((v-axMin)/axRange)*96+2;
    const jitter=6; // small up/down jitter to avoid full overlap
    const yBase=20;
    // Stack overlapping dots
    let yOff=0;
    for(let j=0;j<rank;j++){
      const prevV=values[sortedIdx[j]];
      if(Math.abs(prevV-v)<axRange*0.04) yOff=(yOff===0?-4:yOff===-4?4:0);
    }
    dots.push({x,y:yBase+yOff,color:modelColors[i],name:modelNames[i],val:v,idx:i});
  });

  const dotsSVG=dots.map(d=>`
    <circle cx="${d.x}%" cy="${d.y}" r="6" fill="${d.color}" opacity="0.9" stroke="${d.color}" stroke-width="1">
      <title>${d.name}: ${fmt(d.val,decimals)}${unit}</title>
    </circle>`).join('');

  const bandSVG=(q1Pct!=null&&q3Pct!=null)?
    `<rect x="${q1Pct}%" y="10" width="${Math.max(0.5,q3Pct-q1Pct)}%" height="20" rx="2" fill="rgba(240,165,0,0.15)" stroke="rgba(240,165,0,0.35)" stroke-width="1"/>`:
    '';

  const meanSVG=mPct!=null?
    `<line x1="${mPct}%" y1="4" x2="${mPct}%" y2="36" stroke="#f0a500" stroke-width="2" stroke-dasharray="4,3"/>
     <text x="${mPct}%" y="1.5" text-anchor="middle" fill="#f0a500" font-size="8" font-family="monospace">avg</text>`:
    '';

  // Min and max labels
  const loLabel=lo!=null?`<text x="${loPct}%" y="42" text-anchor="middle" fill="#6a8099" font-size="9" font-family="monospace">${fmt(lo,decimals)}</text>`:'';
  const hiLabel=hi!=null?`<text x="${hiPct}%" y="42" text-anchor="middle" fill="#6a8099" font-size="9" font-family="monospace">${fmt(hi,decimals)}</text>`:'';
  const avgLabel=mean!=null?`<text x="${mPct}%" y="48" text-anchor="middle" fill="#f0a500" font-size="9" font-family="monospace">${fmt(mean,decimals)}</text>`:'';

  return `
    <div class="strip-block">
      <div class="strip-metric-label">
        ${labelText} (${unit})
        <span class="strip-consensus-tag ${spreadClass}">${spreadLabel}</span>
        <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">spread: ${fmt(spread,decimals)}${unit}</span>
      </div>
      <svg class="strip-svg-wrap" viewBox="0 0 100 50" preserveAspectRatio="none" style="height:52px;width:100%;overflow:visible">
        <rect x="2%" y="17" width="96%" height="6" rx="3" fill="rgba(20,30,44,0.9)" stroke="rgba(30,45,61,0.8)" stroke-width="0.5"/>
        ${bandSVG}
        ${meanSVG}
        ${dotsSVG}
        ${loLabel}${hiLabel}${avgLabel}
      </svg>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGREEMENT MATRIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAgreementMatrix(results){
  const metrics=[
    {key:'high',   label:'High Temp', type:'temp', unit:ul('temp'), dec:units==='imperial'?0:1},
    {key:'low',    label:'Low Temp',  type:'temp', unit:ul('temp'), dec:units==='imperial'?0:1},
    {key:'precipProb', label:'Precip %', type:'pct',  unit:'%',  dec:0},
    {key:'wind',   label:'Wind',       type:'wind', unit:ul('wind'), dec:0},
    {key:'gusts',  label:'Gusts',      type:'wind', unit:ul('wind'), dec:0},
  ];

  const avgs={};
  const stds={};
  metrics.forEach(m=>{
    const vals=results.map(r=>conv(r[m.key],m.type));
    avgs[m.key]=avg(vals);
    stds[m.key]=stdDev(vals)||1;
  });

  let html='';

  // Header row
  html+=`<div class="ag-header ag-row-label" style="grid-column:1;background:var(--bg3)">MODEL</div>`;
  metrics.forEach(m=>{ html+=`<div class="ag-header">${m.label}</div>`; });

  // Data rows
  results.forEach(r=>{
    html+=`<div class="ag-row-label">${r.model.name}</div>`;
    metrics.forEach(m=>{
      const rawVal=r[m.key];
      const v=conv(rawVal,m.type);
      const meanV=avgs[m.key];
      const sdV=stds[m.key];
      const dev=v!=null&&meanV!=null?Math.abs(v-meanV):null;
      const zScore=dev!=null&&sdV?dev/sdV:null;

      let cellClass='deviation-none';
      let outlierDot='';
      if(zScore!=null){
        if(zScore<0.5)       cellClass='deviation-low';
        else if(zScore<1.2)  cellClass='deviation-med';
        else                 {cellClass='deviation-high'; outlierDot='<div class="outlier-flag"></div>';}
      }

      const devStr=dev!=null?`${dev>0.05?'Î”':'Â±'}${fmt(dev,m.dec)}`:'';
      html+=`<div class="ag-cell ${cellClass}" style="position:relative">
        ${outlierDot}
        <div class="cv">${v!=null?fmt(v,m.dec)+m.unit:'â€”'}</div>
        <div class="cd" style="color:${zScore!=null&&zScore>=1.2?'var(--red)':zScore>=0.5?'var(--amber)':'var(--text-dim)'}">${devStr}</div>
      </div>`;
    });
  });

  // Consensus footer row
  html+=`<div class="ag-row-label ag-footer" style="color:var(--amber);font-weight:600">CONSENSUS</div>`;
  metrics.forEach(m=>{
    const v=avgs[m.key];
    const s=stds[m.key];
    const sd=s!=null?fmt(s,m.dec):'?';
    html+=`<div class="ag-cell ag-footer">
      <div class="cv">${v!=null?fmt(v,m.dec)+m.unit:'â€”'}</div>
      <div class="cd">Â±${sd} Ïƒ</div>
    </div>`;
  });

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CBASE={
  responsive:true,
  maintainAspectRatio:false,
  plugins:{
    legend:{display:false},
    tooltip:{
      backgroundColor:'#0f1318',borderColor:'#1e2d3d',borderWidth:1,
      titleColor:'#f0a500',bodyColor:'#c8d8e8',
      titleFont:{family:"'Share Tech Mono', monospace",size:11},
      bodyFont:{family:"'Barlow Condensed', sans-serif",size:13},
    }
  },
  scales:{
    x:{ticks:{color:'#6a8099',font:{family:"'Share Tech Mono', monospace",size:9},maxRotation:35},grid:{color:'rgba(30,45,61,0.6)'}},
    y:{ticks:{color:'#6a8099',font:{family:"'Share Tech Mono', monospace",size:10}},grid:{color:'rgba(30,45,61,0.6)'}},
  }
};

function killCharts(){[chartTemp,chartPrecip,chartWind].forEach(c=>c&&c.destroy());}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(results){
  const tU=ul('temp'), wU=ul('wind'), pU=ul('precip');
  const iF=units==='imperial';
  const dT=iF?0:1;

  const highs   =results.map(r=>conv(r.high,'temp'));
  const lows    =results.map(r=>conv(r.low,'temp'));
  const probs   =results.map(r=>r.precipProb);
  const winds   =results.map(r=>conv(r.wind,'wind'));
  const gusts   =results.map(r=>conv(r.gusts,'wind'));
  const hums    =results.map(r=>r.humidity);

  const $=id=>document.getElementById(id);

  // â”€â”€ Narrative â”€â”€
  const nar=generateNarrative(results);
  $('narrative-icon').textContent=nar.icon;
  $('narrative-text').textContent=nar.text;
  $('narrative-detail').innerHTML=nar.detail;
  $('narrative-warn').textContent=nar.warn;

  // â”€â”€ Stat Cards â”€â”€
  function fillCard(valId,rangeId,agreeId,vals,type,unitSuffix,lo,hi){
    const a=avg(vals), mn=vmin(vals), mx=vmax(vals), sp=sprd(vals);
    $(valId).innerHTML=`${fmt(a,dT)}<span class="u">${unitSuffix}</span>`;
    $(rangeId).textContent=`Range: ${fmt(mn,dT)} â€“ ${fmt(mx,dT)}${unitSuffix}`;
    if(agreeId){
      const cls=scls(sp,lo,hi);
      const lbl=sclsLabel(sp,lo,hi);
      $(agreeId).innerHTML=`<span class="${cls}">${lbl}</span>`;
    }
  }

  const tLo=iF?5:3, tHi=iF?12:7;
  const wLo=iF?7:10, wHi=iF?16:25;

  fillCard('s-high','s-high-range','s-high-agree',highs,'temp',tU,tLo,tHi);
  fillCard('s-low','s-low-range','s-low-agree',lows,'temp',tU,tLo,tHi);
  fillCard('s-precip','s-precip-range','s-precip-agree',probs,'pct','%',15,35);
  fillCard('s-wind','s-wind-range','s-wind-agree',winds,'wind',wU,wLo,wHi);

  const hV=hums.filter(x=>x!=null);
  if(hV.length){
    $('s-humidity').innerHTML=`${fmt(avg(hums),0)}<span class="u">%</span>`;
    $('s-humidity-range').textContent=`Range: ${fmt(vmin(hums),0)} â€“ ${fmt(vmax(hums),0)}%`;
    $('s-humidity-agree').innerHTML=`<span class="${scls(sprd(hums),10,25)}">${sclsLabel(sprd(hums),10,25)}</span>`;
  } else {
    $('s-humidity').innerHTML=`N/A`;
    $('s-humidity-range').textContent='Not available for these models';
    $('s-humidity-agree').textContent='â€”';
  }

  $('u-hi').textContent=tU; $('u-lo').textContent=tU; $('u-wi').textContent=wU;

  // â”€â”€ Strip Charts â”€â”€
  const names =results.map(r=>r.model.name);
  const colors=results.map(r=>r.model.color);

  let stripsHTML='';
  stripsHTML+=buildStripChart(highs,colors,names,'Temperature High',tU,dT);
  stripsHTML+='<hr class="strip-divider">';
  stripsHTML+=buildStripChart(lows,colors,names,'Temperature Low',tU,dT);
  stripsHTML+='<hr class="strip-divider">';
  stripsHTML+=buildStripChart(probs,colors,names,'Precipitation Probability','%',0);
  stripsHTML+='<hr class="strip-divider">';
  stripsHTML+=buildStripChart(winds,colors,names,'Wind Speed',wU,0);
  stripsHTML+='<hr class="strip-divider">';
  stripsHTML+=buildStripChart(gusts,colors,names,'Wind Gusts',wU,0);

  // Model color legend
  stripsHTML+=`<div style="margin-top:14px;display:flex;flex-wrap:wrap;gap:8px">`;
  results.forEach(r=>{
    stripsHTML+=`<span style="font-family:var(--mono);font-size:10px;color:${r.model.color};background:rgba(0,0,0,.3);border:1px solid ${r.model.color}44;padding:2px 8px;border-radius:2px">${r.model.name}</span>`;
  });
  stripsHTML+=`</div>`;

  $('strip-charts').innerHTML=stripsHTML;

  // â”€â”€ Agreement Matrix â”€â”€
  $('agree-grid').innerHTML=buildAgreementMatrix(results);

  // â”€â”€ Table headers â”€â”€
  $('th-hi').textContent=`High ${tU}`;
  $('th-lo').textContent=`Low ${tU}`;
  $('th-ps').textContent=`Precip (${pU})`;
  $('th-wi').textContent=`Wind (${wU})`;
  $('th-gu').textContent=`Gusts (${wU})`;
  $('title-temp').textContent=`Temperature Range per Model (${tU})`;
  $('title-wind').textContent=`Wind Speed & Gusts â€” All Models (${wU})`;

  // â”€â”€ Table Body â”€â”€
  const avgHighs=avg(highs), avgLows=avg(lows), avgProbs=avg(probs), avgWinds=avg(winds);
  const sdHighs=stdDev(highs)||1, sdLows=stdDev(lows)||1;
  const sdProbs=stdDev(probs)||1, sdWinds=stdDev(winds)||1;

  const tbody=$('tbody');
  tbody.innerHTML='';
  results.forEach(r=>{
    const rH=conv(r.high,'temp'), rL=conv(r.low,'temp'), rW=conv(r.wind,'wind'), rG=conv(r.gusts,'wind');
    const isOutlierH=rH!=null&&Math.abs(rH-avgHighs)/sdHighs>1.5;
    const isOutlierP=r.precipProb!=null&&Math.abs(r.precipProb-avgProbs)/sdProbs>1.5;
    const isOutlierW=rW!=null&&Math.abs(rW-avgWinds)/sdWinds>1.5;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="td-model-name" style="color:${r.model.color}">${r.model.name}</span><span class="td-model-origin">${r.model.origin}</span></td>
      <td class="v-hi ${isOutlierH?'outlier-cell':''}">${fmt(rH,dT)}Â°</td>
      <td class="v-lo">${fmt(rL,dT)}Â°</td>
      <td class="v-pr ${isOutlierP?'outlier-cell':''}">${fmt(r.precipProb,0)}%</td>
      <td class="v-pr">${fmt(conv(r.precipSum,'precip'),2)}</td>
      <td class="v-wi ${isOutlierW?'outlier-cell':''}">${fmt(rW,0)}</td>
      <td class="v-wi">${fmt(rG,0)}</td>
      <td class="v-hu">${fmt(r.humidity,0)}%</td>
      <td class="v-cl">${fmt(r.cloud,0)}%</td>
      <td class="v-uv">${fmt(r.uv,1)}</td>`;
    tbody.appendChild(tr);
  });

  // â”€â”€ CHARTS â”€â”€
  killCharts();

  // Average line annotation helper (inline dataset approach)
  const avgHighD=avgHighs, avgLowD=avg(lows), avgProbD=avgProbs, avgWindD=avgWinds, avgGustD=avg(gusts);

  // Temperature floating bar + avg line
  chartTemp=new Chart($('temp-chart').getContext('2d'),{
    data:{
      labels:names,
      datasets:[
        {
          type:'bar',
          label:`Low â†’ High (${tU})`,
          data:results.map(r=>[conv(r.low,'temp'),conv(r.high,'temp')]),
          backgroundColor:colors.map(c=>c+'99'),
          borderColor:colors,
          borderWidth:1,
          borderRadius:2,
          order:2,
        },
        {
          type:'line',
          label:`Avg High (${tU})`,
          data:Array(results.length).fill(avgHighD),
          borderColor:'#f0a500',
          borderWidth:2,
          borderDash:[5,4],
          pointRadius:0,
          tension:0,
          order:1,
        },
        {
          type:'line',
          label:`Avg Low (${tU})`,
          data:Array(results.length).fill(avgLowD),
          borderColor:'#00d4e8',
          borderWidth:2,
          borderDash:[5,4],
          pointRadius:0,
          tension:0,
          order:1,
        },
      ]
    },
    options:{
      ...CBASE,
      plugins:{
        ...CBASE.plugins,
        legend:{
          display:true,
          labels:{color:'#6a8099',font:{family:"'Share Tech Mono',monospace",size:9},boxWidth:10}
        },
        tooltip:{...CBASE.plugins.tooltip,
          callbacks:{label:ctx=>ctx.datasetIndex===0?` Low: ${fmt(ctx.raw[0],dT)}${tU}  â†’  High: ${fmt(ctx.raw[1],dT)}${tU}`:` ${ctx.dataset.label}: ${fmt(ctx.raw,dT)}${tU}`}
        }
      }
    }
  });

  // Precip bars + avg line + 50% threshold
  chartPrecip=new Chart($('precip-chart').getContext('2d'),{
    data:{
      labels:names,
      datasets:[
        {
          type:'bar',
          label:'Precip Probability (%)',
          data:probs,
          backgroundColor:probs.map(p=>{
            if(p==null) return '#33445588';
            if(p>=70)   return '#00d4e888';
            if(p>=40)   return '#4da6ff88';
            return '#3dd68c88';
          }),
          borderColor:probs.map(p=>{
            if(p==null) return '#334455';
            if(p>=70)   return '#00d4e8';
            if(p>=40)   return '#4da6ff';
            return '#3dd68c';
          }),
          borderWidth:1,
          borderRadius:2,
          order:2,
        },
        {
          type:'line',
          label:'Average (%)',
          data:Array(results.length).fill(avgProbD),
          borderColor:'#f0a500',
          borderWidth:2,
          borderDash:[5,4],
          pointRadius:0,
          tension:0,
          order:1,
        },
        {
          type:'line',
          label:'50% Threshold',
          data:Array(results.length).fill(50),
          borderColor:'#ffffff33',
          borderWidth:1,
          borderDash:[3,3],
          pointRadius:0,
          tension:0,
          order:1,
        },
      ]
    },
    options:{
      ...CBASE,
      plugins:{
        ...CBASE.plugins,
        legend:{
          display:true,
          labels:{color:'#6a8099',font:{family:"'Share Tech Mono',monospace",size:9},boxWidth:10}
        }
      },
      scales:{...CBASE.scales,y:{...CBASE.scales.y,min:0,max:100}}
    }
  });

  // Wind grouped bars + avg lines
  chartWind=new Chart($('wind-chart').getContext('2d'),{
    data:{
      labels:names,
      datasets:[
        {
          type:'bar',
          label:`Sustained Wind (${wU})`,
          data:winds,
          backgroundColor:'#3dd68c88',
          borderColor:'#3dd68c',
          borderWidth:1,
          borderRadius:2,
          order:2,
        },
        {
          type:'bar',
          label:`Gusts (${wU})`,
          data:gusts,
          backgroundColor:'#f2575766',
          borderColor:'#f25757',
          borderWidth:1,
          borderRadius:2,
          order:2,
        },
        {
          type:'line',
          label:`Avg Wind (${wU})`,
          data:Array(results.length).fill(avgWindD),
          borderColor:'#3dd68c',
          borderWidth:2,
          borderDash:[5,4],
          pointRadius:0,
          tension:0,
          order:1,
        },
        {
          type:'line',
          label:`Avg Gusts (${wU})`,
          data:Array(results.length).fill(avgGustD),
          borderColor:'#f25757',
          borderWidth:2,
          borderDash:[5,4],
          pointRadius:0,
          tension:0,
          order:1,
        },
      ]
    },
    options:{
      ...CBASE,
      plugins:{
        ...CBASE.plugins,
        legend:{
          display:true,
          labels:{color:'#6a8099',font:{family:"'Share Tech Mono',monospace",size:9},boxWidth:10,padding:12}
        }
      }
    }
  });

  $('results').classList.add('visible');
  if(window.innerWidth<768) setTimeout(()=>$('results').scrollIntoView({behavior:'smooth',block:'start'}),100);
}
</script>
</body>
</html>
