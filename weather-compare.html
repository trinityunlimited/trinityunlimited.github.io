<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeatherMatrix — Multi-Model Forecast Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0d12;
    --bg2: #0f1318;
    --bg3: #151b24;
    --panel: #111820;
    --border: #1e2d3d;
    --border2: #243447;
    --amber: #f0a500;
    --amber2: #ffc94d;
    --amber-dim: rgba(240,165,0,0.12);
    --cyan: #00d4e8;
    --green: #3dd68c;
    --red: #f25757;
    --blue: #4da6ff;
    --purple: #b97bff;
    --orange: #ff7b45;
    --text: #c8d8e8;
    --text-dim: #6a8099;
    --text-bright: #e8f4ff;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow Condensed', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 16px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(30,45,61,0.3) 1px, transparent 1px),
      linear-gradient(90deg, rgba(30,45,61,0.3) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrap {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 20px 60px;
  }

  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo { display: flex; align-items: baseline; gap: 10px; }

  .logo-mark {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--amber);
    letter-spacing: 0.15em;
    padding: 3px 8px;
    border: 1px solid var(--amber);
    border-radius: 2px;
    background: var(--amber-dim);
  }

  .logo h1 {
    font-family: var(--sans);
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--text-bright);
    line-height: 1;
  }

  .logo h1 span { color: var(--amber); }

  .header-right {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    line-height: 1.8;
  }

  .header-right .live { color: var(--green); }

  .controls {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 12px;
    margin-bottom: 12px;
    align-items: end;
  }

  .field { display: flex; flex-direction: column; gap: 6px; }

  .field label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--amber);
    text-transform: uppercase;
  }

  .field input, .field select {
    background: var(--panel);
    border: 1px solid var(--border2);
    color: var(--text-bright);
    font-family: var(--sans);
    font-size: 17px;
    font-weight: 400;
    padding: 10px 14px;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }

  .field input:focus, .field select:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 2px rgba(240,165,0,0.12);
  }

  .field input::placeholder { color: var(--text-dim); }
  .field select option { background: var(--bg3); color: var(--text-bright); }

  .btn-fetch {
    background: var(--amber);
    color: #0a0d12;
    border: none;
    font-family: var(--sans);
    font-size: 17px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 10px 28px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    align-self: end;
  }

  .btn-fetch:hover { background: var(--amber2); }
  .btn-fetch:active { transform: scale(0.98); }
  .btn-fetch:disabled { background: #4a3d0a; color: #7a6a2a; cursor: not-allowed; }

  .unit-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
  }

  .unit-btn {
    background: var(--panel);
    border: 1px solid var(--border2);
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .unit-btn.active {
    background: var(--amber-dim);
    border-color: var(--amber);
    color: var(--amber);
  }

  #status-bar {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-dim);
    padding: 8px 14px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 16px;
    min-height: 34px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #status-bar .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }

  #status-bar.loading .dot { background: var(--amber); animation: blink 0.8s infinite; }
  #status-bar.success .dot { background: var(--green); }
  #status-bar.error   .dot { background: var(--red); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .location-wrapper { position: relative; }

  #suggestions {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 4px;
    z-index: 100;
    max-height: 220px;
    overflow-y: auto;
    display: none;
  }

  #suggestions.open { display: block; }

  .suggestion-item {
    padding: 9px 14px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border);
  }

  .suggestion-item:last-child { border-bottom: none; }
  .suggestion-item:hover { background: var(--border); }
  .suggestion-item .sub { color: var(--text-dim); font-size: 13px; margin-left: 6px; }

  #progress-wrap { margin-bottom: 20px; display: none; }
  #progress-wrap.visible { display: block; }

  .progress-models { display: flex; flex-wrap: wrap; gap: 8px; }

  .model-pill {
    font-family: var(--mono);
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 2px;
    border: 1px solid var(--border2);
    color: var(--text-dim);
    background: var(--bg3);
    transition: all 0.3s;
    letter-spacing: 0.05em;
  }

  .model-pill.loading { border-color: var(--amber); color: var(--amber); background: var(--amber-dim); }
  .model-pill.success { border-color: var(--green); color: var(--green); background: rgba(61,214,140,0.1); }
  .model-pill.failed  { border-color: var(--border); color: #3a4a5a; text-decoration: line-through; }

  #results { display: none; }
  #results.visible { display: block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 16px;
    position: relative;
    overflow: hidden;
  }

  .summary-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .summary-card.temp::before    { background: var(--amber); }
  .summary-card.precip::before  { background: var(--cyan); }
  .summary-card.wind::before    { background: var(--green); }
  .summary-card.humidity::before{ background: var(--blue); }
  .summary-card.cloud::before   { background: var(--purple); }

  .s-label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 0.2em;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .s-value {
    font-family: var(--mono);
    font-size: 26px;
    color: var(--text-bright);
    line-height: 1;
  }

  .s-value .unit { font-size: 14px; color: var(--text-dim); margin-left: 2px; }

  .s-range {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .chart-panel, .full-chart-panel, .consensus-panel, .table-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .chart-panel { margin-bottom: 0; }

  .chart-panel h3, .full-chart-panel h3, .consensus-panel h3, .table-panel h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .chart-container { position: relative; height: 220px; }
  .full-chart-container { position: relative; height: 260px; }

  .consensus-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }

  .ci {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px 14px;
  }

  .ci-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    margin-bottom: 6px;
    text-transform: uppercase;
  }

  .ci-value {
    font-family: var(--mono);
    font-size: 22px;
    color: var(--text-bright);
  }

  .ci-spread {
    font-family: var(--mono);
    font-size: 11px;
    margin-top: 3px;
    color: var(--text-dim);
  }

  .spread-low  { color: var(--green) !important; }
  .spread-med  { color: var(--amber) !important; }
  .spread-high { color: var(--red)   !important; }

  table { width: 100%; border-collapse: collapse; font-size: 14px; }

  thead th {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    text-transform: uppercase;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border2);
    white-space: nowrap;
  }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover { background: rgba(255,255,255,0.03); }
  tbody tr:last-child { border-bottom: none; }
  tbody td { padding: 10px 12px; white-space: nowrap; }

  .td-model-name  { font-weight: 600; color: var(--text-bright); font-size: 15px; }
  .td-model-origin{ font-family: var(--mono); font-size: 10px; color: var(--text-dim); display: block; margin-top: 1px; }

  .v-hi  { color: var(--amber);  font-family: var(--mono); font-size: 15px; }
  .v-lo  { color: var(--cyan);   font-family: var(--mono); font-size: 15px; }
  .v-pr  { color: var(--blue);   font-family: var(--mono); font-size: 15px; }
  .v-wi  { color: var(--green);  font-family: var(--mono); font-size: 15px; }
  .v-hu  { color: var(--purple); font-family: var(--mono); font-size: 15px; }
  .v-cl  { color: #aaa;          font-family: var(--mono); font-size: 15px; }
  .v-uv  { color: var(--orange); font-family: var(--mono); font-size: 15px; }

  footer {
    border-top: 1px solid var(--border);
    padding-top: 20px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
  }

  footer p { font-family: var(--mono); font-size: 11px; color: var(--text-dim); line-height: 1.7; }
  footer a  { color: var(--amber); text-decoration: none; }

  .model-legend { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }

  .legend-tag {
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 2px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text-dim);
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  @media (max-width: 900px) {
    .summary-grid   { grid-template-columns: repeat(3,1fr); }
    .charts-row     { grid-template-columns: 1fr; }
    .consensus-grid { grid-template-columns: repeat(2,1fr); }
    .controls       { grid-template-columns: 1fr 1fr; }
    .btn-fetch      { grid-column: 1/-1; }
    header          { flex-direction: column; align-items: flex-start; gap: 12px; }
  }

  @media (max-width: 560px) {
    .summary-grid   { grid-template-columns: 1fr 1fr; }
    .consensus-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo">
      <span class="logo-mark">v2.1</span>
      <h1>Weather<span>Matrix</span></h1>
    </div>
    <div class="header-right">
      <span class="live">● LIVE DATA</span> — OPEN METEOROLOGICAL MODELS<br>
      12 INDEPENDENT FORECAST SOURCES — NO SIGN-UP REQUIRED<br>
      HRRR · GFS · NAM · NBM · ECMWF · ICON · GEM · MORE
    </div>
  </header>

  <div class="controls">
    <div class="field">
      <label>Location</label>
      <div class="location-wrapper">
        <input type="text" id="location-input" placeholder="City, state, or ZIP code…" autocomplete="off" spellcheck="false" />
        <div id="suggestions"></div>
      </div>
    </div>
    <div class="field">
      <label>Forecast Day</label>
      <select id="day-select"></select>
    </div>
    <button class="btn-fetch" id="fetch-btn" onclick="fetchAllModels()">RUN ANALYSIS</button>
  </div>

  <div class="unit-toggle">
    UNITS:
    <button class="unit-btn active" id="btn-imperial" onclick="setUnits('imperial')">°F / mph / in</button>
    <button class="unit-btn"        id="btn-metric"   onclick="setUnits('metric')">°C / km/h / mm</button>
  </div>

  <div id="status-bar">
    <div class="dot"></div>
    <span id="status-text">Enter a location and select a day to begin.</span>
  </div>

  <div id="progress-wrap">
    <div class="progress-models" id="progress-pills"></div>
  </div>

  <div id="results">

    <div class="summary-grid">
      <div class="summary-card temp">
        <div class="s-label">Avg High Temp</div>
        <div class="s-value" id="s-high">--<span class="unit" id="u-hi">°F</span></div>
        <div class="s-range" id="s-high-range">Range: --</div>
      </div>
      <div class="summary-card temp">
        <div class="s-label">Avg Low Temp</div>
        <div class="s-value" id="s-low">--<span class="unit" id="u-lo">°F</span></div>
        <div class="s-range" id="s-low-range">Range: --</div>
      </div>
      <div class="summary-card precip">
        <div class="s-label">Avg Precip Chance</div>
        <div class="s-value" id="s-precip">--<span class="unit">%</span></div>
        <div class="s-range" id="s-precip-range">Range: --</div>
      </div>
      <div class="summary-card wind">
        <div class="s-label">Avg Wind Speed</div>
        <div class="s-value" id="s-wind">--<span class="unit" id="u-wi">mph</span></div>
        <div class="s-range" id="s-wind-range">Range: --</div>
      </div>
      <div class="summary-card humidity">
        <div class="s-label">Avg Humidity</div>
        <div class="s-value" id="s-humidity">--<span class="unit">%</span></div>
        <div class="s-range" id="s-humidity-range">Range: --</div>
      </div>
    </div>

    <div class="consensus-panel">
      <h3>Model Consensus Analysis</h3>
      <div class="consensus-grid">
        <div class="ci">
          <div class="ci-label">Temperature High</div>
          <div class="ci-value" id="c-temp">--</div>
          <div class="ci-spread" id="c-temp-spread">Spread: --</div>
        </div>
        <div class="ci">
          <div class="ci-label">Precipitation Chance</div>
          <div class="ci-value" id="c-precip">--%</div>
          <div class="ci-spread" id="c-precip-spread">Spread: --</div>
        </div>
        <div class="ci">
          <div class="ci-label">Wind Speed</div>
          <div class="ci-value" id="c-wind">--</div>
          <div class="ci-spread" id="c-wind-spread">Spread: --</div>
        </div>
        <div class="ci">
          <div class="ci-label">Rain Likelihood Vote</div>
          <div class="ci-value" id="c-rain">--</div>
          <div class="ci-spread" id="c-rain-sub">Models agree: --</div>
        </div>
        <div class="ci">
          <div class="ci-label">Overall Confidence</div>
          <div class="ci-value" id="c-conf">--</div>
          <div class="ci-spread">Based on model spread</div>
        </div>
        <div class="ci">
          <div class="ci-label">Models With Data</div>
          <div class="ci-value" id="c-count">--</div>
          <div class="ci-spread" id="c-count-sub">of 12 sources queried</div>
        </div>
      </div>
    </div>

    <div class="charts-row">
      <div class="chart-panel">
        <h3 id="title-temp">Temperature Range by Model (°F)</h3>
        <div class="chart-container"><canvas id="temp-chart"></canvas></div>
      </div>
      <div class="chart-panel">
        <h3>Precipitation Probability by Model (%)</h3>
        <div class="chart-container"><canvas id="precip-chart"></canvas></div>
      </div>
    </div>

    <div class="full-chart-panel">
      <h3 id="title-wind">Wind Speed &amp; Gusts — All Models (mph)</h3>
      <div class="full-chart-container"><canvas id="wind-chart"></canvas></div>
    </div>

    <div class="table-panel">
      <h3>Full Data Table — All Models</h3>
      <table>
        <thead>
          <tr>
            <th>Model</th>
            <th id="th-hi">High °F</th>
            <th id="th-lo">Low °F</th>
            <th>Precip %</th>
            <th id="th-ps">Precip (in)</th>
            <th id="th-wi">Wind (mph)</th>
            <th id="th-gu">Gusts (mph)</th>
            <th>Humidity %</th>
            <th>Cloud %</th>
            <th>UV Index</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div><!-- #results -->

  <footer>
    <p>
      Data from <a href="https://open-meteo.com" target="_blank">Open-Meteo</a> — free, open-source, no API key needed.<br>
      US-specific: HRRR (hourly hi-res), NAM CONUS, NBM (National Blend of Models), GFS.<br>
      Global: ECMWF IFS, DWD ICON, Env. Canada GEM, JMA, Météo-France, ECMWF hi-res.
    </p>
    <div class="model-legend">
      <span class="legend-tag">HRRR · USA</span>
      <span class="legend-tag">GFS · USA</span>
      <span class="legend-tag">NAM · USA</span>
      <span class="legend-tag">NBM · USA</span>
      <span class="legend-tag">ECMWF · EU</span>
      <span class="legend-tag">ICON · DE</span>
      <span class="legend-tag">GEM · CA</span>
      <span class="legend-tag">JMA · JP</span>
      <span class="legend-tag">AROME · FR</span>
      <span class="legend-tag">BEST-MATCH</span>
    </div>
  </footer>

</div><!-- .wrap -->

<script>
// ─────────────────────────────────────────────────────────────────────────────
// MODEL REGISTRY
// ─────────────────────────────────────────────────────────────────────────────
const MODELS = [
  { id: 'best_match',           name: 'Best-Match',         origin: 'Auto-selected best available',   color: '#f0a500' },
  { id: 'gfs_seamless',         name: 'NOAA GFS',           origin: 'Natl Weather Service, USA',       color: '#3dd68c' },
  { id: 'gfs025',               name: 'GFS 0.25°',          origin: 'Natl Weather Service (hi-res)',   color: '#5debb0' },
  { id: 'hrrr_conus',           name: 'NOAA HRRR',          origin: 'High-Res Rapid Refresh, USA',     color: '#ff7b45' },
  { id: 'ncep_nbm_conus',       name: 'NCEP NBM',           origin: 'National Blend of Models, USA',   color: '#ffb347' },
  { id: 'nam_conus',            name: 'NOAA NAM',           origin: 'North American Mesoscale, USA',   color: '#ff4d8b' },
  { id: 'ecmwf_ifs04',          name: 'ECMWF IFS',          origin: 'European Centre for MWF, EU',     color: '#00d4e8' },
  { id: 'ecmwf_ifs025',         name: 'ECMWF 0.25°',        origin: 'European Centre (hi-res)',        color: '#5bc8f5' },
  { id: 'icon_seamless',        name: 'DWD ICON',           origin: 'Deutscher Wetterdienst, Germany', color: '#4da6ff' },
  { id: 'gem_seamless',         name: 'Env. Canada GEM',    origin: 'Environment Canada',              color: '#b97bff' },
  { id: 'meteofrance_seamless', name: 'Météo-France',       origin: 'Météo-France AROME/ARPEGE',       color: '#f25757' },
  { id: 'jma_seamless',         name: 'JMA MSM',            origin: 'Japan Meteorological Agency',     color: '#a8e063' },
];

// ─────────────────────────────────────────────────────────────────────────────
// STATE
// ─────────────────────────────────────────────────────────────────────────────
let selLat = null, selLon = null, selName = '';
let units = 'imperial';
let lastResults = [];
let chartTemp = null, chartPrecip = null, chartWind = null;
let geoTimer = null;

// ─────────────────────────────────────────────────────────────────────────────
// DAY SELECTOR
// ─────────────────────────────────────────────────────────────────────────────
const DNAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MNAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

(function initDays() {
  const sel = document.getElementById('day-select');
  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() + i);
    const lbl = i === 0 ? `Today — ${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`
              : i === 1 ? `Tomorrow — ${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`
              : `${DNAMES[d.getDay()]} ${d.getDate()} ${MNAMES[d.getMonth()]}`;
    const o = document.createElement('option');
    o.value = i; o.textContent = lbl;
    sel.appendChild(o);
  }
})();

// ─────────────────────────────────────────────────────────────────────────────
// UNITS
// ─────────────────────────────────────────────────────────────────────────────
function setUnits(u) {
  units = u;
  document.getElementById('btn-imperial').classList.toggle('active', u === 'imperial');
  document.getElementById('btn-metric').classList.toggle('active',   u === 'metric');
  if (lastResults.length) renderResults(lastResults);
}

function conv(v, type) {
  if (v == null) return null;
  if (units === 'imperial') {
    if (type === 'temp')   return v * 9/5 + 32;
    if (type === 'wind')   return v * 0.621371;
    if (type === 'precip') return v * 0.0393701;
  }
  return v;
}

function ul(type) {
  if (type === 'temp')   return units === 'imperial' ? '°F' : '°C';
  if (type === 'wind')   return units === 'imperial' ? 'mph' : 'km/h';
  if (type === 'precip') return units === 'imperial' ? 'in' : 'mm';
  return '';
}

// ─────────────────────────────────────────────────────────────────────────────
// GEOCODING
// ─────────────────────────────────────────────────────────────────────────────
const locInput  = document.getElementById('location-input');
const suggBox   = document.getElementById('suggestions');

locInput.addEventListener('input', () => {
  clearTimeout(geoTimer);
  const q = locInput.value.trim();
  if (q.length < 2) { suggBox.classList.remove('open'); return; }
  geoTimer = setTimeout(() => doGeoSuggest(q), 350);
});

locInput.addEventListener('blur',   () => setTimeout(() => suggBox.classList.remove('open'), 200));
locInput.addEventListener('keydown', e => { if (e.key === 'Enter') { suggBox.classList.remove('open'); fetchAllModels(); } });

async function doGeoSuggest(q) {
  try {
    // Prefer US results
    let results = await geoSearch(q, 'US');
    if (!results.length) results = await geoSearch(q, '');
    if (!results.length) { suggBox.classList.remove('open'); return; }
    suggBox.innerHTML = '';
    results.slice(0,6).forEach(r => {
      const d = document.createElement('div');
      d.className = 'suggestion-item';
      d.innerHTML = `<strong>${r.name}</strong><span class="sub">${[r.admin1, r.country].filter(Boolean).join(', ')}</span>`;
      d.addEventListener('mousedown', () => {
        selLat = r.latitude; selLon = r.longitude;
        selName = [r.name, r.admin1, r.country].filter(Boolean).join(', ');
        locInput.value = selName;
        suggBox.classList.remove('open');
      });
      suggBox.appendChild(d);
    });
    suggBox.classList.add('open');
  } catch(_) { suggBox.classList.remove('open'); }
}

async function geoSearch(q, countryCode) {
  const cc = countryCode ? `&countryCode=${countryCode}` : '';
  const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=en&format=json${cc}`);
  const d = await r.json();
  return d.results || [];
}

// ─────────────────────────────────────────────────────────────────────────────
// STATUS / PROGRESS
// ─────────────────────────────────────────────────────────────────────────────
function setStatus(msg, type = '') {
  document.getElementById('status-bar').className = type;
  document.getElementById('status-text').textContent = msg;
}

function initPills() {
  const wrap = document.getElementById('progress-wrap');
  const box  = document.getElementById('progress-pills');
  box.innerHTML = '';
  wrap.classList.add('visible');
  MODELS.forEach(m => {
    const el = document.createElement('div');
    el.className = 'model-pill loading';
    el.id = `pill-${m.id}`;
    el.textContent = m.name;
    box.appendChild(el);
  });
}

function setPill(id, state) {
  const el = document.getElementById(`pill-${id}`);
  if (el) el.className = `model-pill ${state}`;
}

// ─────────────────────────────────────────────────────────────────────────────
// FETCH ALL MODELS
// ─────────────────────────────────────────────────────────────────────────────
async function fetchAllModels() {
  // Resolve location if needed
  if (!selLat || !selLon || locInput.value !== selName) {
    const q = locInput.value.trim();
    if (!q) { setStatus('Please enter a location first.', 'error'); return; }
    setStatus('Resolving location…', 'loading');
    try {
      let results = await geoSearch(q, 'US');
      if (!results.length) results = await geoSearch(q, '');
      if (!results.length) { setStatus(`Could not find "${q}". Try a different city name.`, 'error'); return; }
      selLat = results[0].latitude;
      selLon = results[0].longitude;
      selName = [results[0].name, results[0].admin1, results[0].country].filter(Boolean).join(', ');
      locInput.value = selName;
    } catch(e) {
      setStatus('Network error. Check your internet connection.', 'error');
      return;
    }
  }

  const btn = document.getElementById('fetch-btn');
  btn.disabled = true;
  initPills();

  const dayOffset = parseInt(document.getElementById('day-select').value);
  const target = new Date();
  target.setDate(target.getDate() + dayOffset);
  const dateStr = target.toISOString().split('T')[0];

  setStatus(`Querying ${MODELS.length} forecast models for ${selName}…`, 'loading');

  // Variables — split into core (always works) and optional (may fail per model)
  const CORE_VARS = [
    'temperature_2m_max',
    'temperature_2m_min',
    'precipitation_sum',
    'precipitation_probability_max',
    'windspeed_10m_max',
    'windgusts_10m_max',
    'uv_index_max',
  ].join(',');

  const EXTRA_VARS = 'cloudcover_mean,relative_humidity_2m_mean';

  const results = [];

  await Promise.all(MODELS.map(async model => {
    try {
      const base = `https://api.open-meteo.com/v1/forecast`
        + `?latitude=${selLat}&longitude=${selLon}`
        + `&daily=${CORE_VARS}`
        + `&timezone=auto&models=${model.id}&forecast_days=8`;

      const resp = await fetch(base);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      if (!data.daily?.time) throw new Error('No daily data');
      const di = data.daily.time.indexOf(dateStr);
      if (di === -1) throw new Error('Date not found');

      const row = {
        model,
        high:       data.daily.temperature_2m_max?.[di]            ?? null,
        low:        data.daily.temperature_2m_min?.[di]             ?? null,
        precipProb: data.daily.precipitation_probability_max?.[di] ?? null,
        precipSum:  data.daily.precipitation_sum?.[di]             ?? null,
        wind:       data.daily.windspeed_10m_max?.[di]             ?? null,
        gusts:      data.daily.windgusts_10m_max?.[di]             ?? null,
        uv:         data.daily.uv_index_max?.[di]                  ?? null,
        humidity:   null,
        cloud:      null,
      };

      // Try extras (non-blocking)
      try {
        const er = await fetch(`https://api.open-meteo.com/v1/forecast`
          + `?latitude=${selLat}&longitude=${selLon}`
          + `&daily=${EXTRA_VARS}`
          + `&timezone=auto&models=${model.id}&forecast_days=8`);
        if (er.ok) {
          const ed = await er.json();
          if (ed.daily?.time) {
            const ei = ed.daily.time.indexOf(dateStr);
            if (ei !== -1) {
              row.humidity = ed.daily.relative_humidity_2m_mean?.[ei] ?? null;
              row.cloud    = ed.daily.cloudcover_mean?.[ei]           ?? null;
            }
          }
        }
      } catch(_) {}

      results.push(row);
      setPill(model.id, 'success');
    } catch(_) {
      setPill(model.id, 'failed');
    }
  }));

  btn.disabled = false;

  if (!results.length) {
    setStatus('All model requests failed. Please check your internet connection and try again.', 'error');
    return;
  }

  const dLbl = dayOffset === 0 ? 'Today'
             : dayOffset === 1 ? 'Tomorrow'
             : `${DNAMES[target.getDay()]} ${target.getDate()} ${MNAMES[target.getMonth()]}`;

  setStatus(`✓ ${results.length} of ${MODELS.length} models returned data — ${selName} — ${dLbl}`, 'success');

  lastResults = results;
  renderResults(results);
}

// ─────────────────────────────────────────────────────────────────────────────
// HELPERS
// ─────────────────────────────────────────────────────────────────────────────
const avg   = a => { const v = a.filter(x=>x!=null); return v.length ? v.reduce((s,x)=>s+x,0)/v.length : null; };
const mn    = a => { const v = a.filter(x=>x!=null); return v.length ? Math.min(...v) : null; };
const mx    = a => { const v = a.filter(x=>x!=null); return v.length ? Math.max(...v) : null; };
const fmt   = (v, d=1) => v == null ? '—' : (+v).toFixed(d);
const sprd  = a => { const lo=mn(a), hi=mx(a); return lo==null ? null : hi-lo; };

function scls(v, low, high) {
  if (v == null) return '';
  return v <= low ? 'spread-low' : v <= high ? 'spread-med' : 'spread-high';
}

// ─────────────────────────────────────────────────────────────────────────────
// RENDER
// ─────────────────────────────────────────────────────────────────────────────
const CBASE = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { display: false },
    tooltip: {
      backgroundColor: '#0f1318', borderColor: '#1e2d3d', borderWidth: 1,
      titleColor: '#f0a500', bodyColor: '#c8d8e8',
      titleFont: { family: "'Share Tech Mono', monospace", size: 11 },
      bodyFont:  { family: "'Barlow Condensed', sans-serif", size: 13 },
    }
  },
  scales: {
    x: { ticks: { color: '#6a8099', font: { family:"'Share Tech Mono', monospace", size:10 } }, grid: { color: 'rgba(30,45,61,0.6)' } },
    y: { ticks: { color: '#6a8099', font: { family:"'Share Tech Mono', monospace", size:10 } }, grid: { color: 'rgba(30,45,61,0.6)' } },
  }
};

function killCharts() {
  [chartTemp, chartPrecip, chartWind].forEach(c => c && c.destroy());
}

function renderResults(results) {
  const tU = ul('temp');
  const wU = ul('wind');
  const pU = ul('precip');
  const dT = units === 'imperial' ? 0 : 1;

  const highs = results.map(r => conv(r.high,  'temp'));
  const lows  = results.map(r => conv(r.low,   'temp'));
  const probs = results.map(r => r.precipProb);
  const winds = results.map(r => conv(r.wind,  'wind'));
  const hums  = results.map(r => r.humidity);

  // Summary cards
  const $  = id => document.getElementById(id);
  $('s-high').innerHTML     = `${fmt(avg(highs),dT)}<span class="unit">${tU}</span>`;
  $('s-high-range').textContent = `Range: ${fmt(mn(highs),dT)}–${fmt(mx(highs),dT)}${tU}`;
  $('s-low').innerHTML      = `${fmt(avg(lows),dT)}<span class="unit">${tU}</span>`;
  $('s-low-range').textContent  = `Range: ${fmt(mn(lows),dT)}–${fmt(mx(lows),dT)}${tU}`;
  $('s-precip').innerHTML   = `${fmt(avg(probs),0)}<span class="unit">%</span>`;
  $('s-precip-range').textContent = `Range: ${fmt(mn(probs),0)}–${fmt(mx(probs),0)}%`;
  $('s-wind').innerHTML     = `${fmt(avg(winds),0)}<span class="unit">${wU}</span>`;
  $('s-wind-range').textContent = `Range: ${fmt(mn(winds),0)}–${fmt(mx(winds),0)} ${wU}`;
  $('s-humidity').innerHTML = `${fmt(avg(hums),0)}<span class="unit">%</span>`;
  $('s-humidity-range').textContent = hums.every(x=>x==null) ? 'No data for this model set'
    : `Range: ${fmt(mn(hums),0)}–${fmt(mx(hums),0)}%`;

  // Unit labels
  $('u-hi').textContent = tU;
  $('u-lo').textContent = tU;
  $('u-wi').textContent = wU;

  // Table headers
  $('th-hi').textContent = `High ${tU}`;
  $('th-lo').textContent = `Low ${tU}`;
  $('th-ps').textContent = `Precip (${pU})`;
  $('th-wi').textContent = `Wind (${wU})`;
  $('th-gu').textContent = `Gusts (${wU})`;

  // Chart titles
  $('title-temp').textContent = `Temperature Range by Model (${tU})`;
  $('title-wind').textContent = `Wind Speed & Gusts — All Models (${wU})`;

  // Consensus
  const tSp = sprd(highs);
  const pSp = sprd(probs);
  const wSp = sprd(winds);
  const tLo = units==='imperial'?4:2, tHi = units==='imperial'?9:5;
  const wLo = units==='imperial'?7:10, wHi = units==='imperial'?16:25;

  $('c-temp').textContent = `${fmt(avg(highs),dT)}${tU}`;
  $('c-temp-spread').innerHTML = `Spread: ${fmt(tSp,dT)}${tU} <span class="${scls(tSp,tLo,tHi)}">(${tSp<=tLo?'LOW':tSp<=tHi?'MEDIUM':'HIGH'})</span>`;

  $('c-precip').textContent = `${fmt(avg(probs),0)}%`;
  $('c-precip-spread').innerHTML = `Spread: ${fmt(pSp,0)}% <span class="${scls(pSp,15,35)}">(${pSp<=15?'LOW':pSp<=35?'MEDIUM':'HIGH'})</span>`;

  $('c-wind').textContent = `${fmt(avg(winds),0)} ${wU}`;
  $('c-wind-spread').innerHTML = `Spread: ${fmt(wSp,0)} ${wU} <span class="${scls(wSp,wLo,wHi)}">(${wSp<=wLo?'LOW':wSp<=wHi?'MEDIUM':'HIGH'})</span>`;

  const yes = probs.filter(p=>p!=null&&p>=50).length;
  const no  = probs.filter(p=>p!=null&&p<50).length;
  const tot = probs.filter(p=>p!=null).length;
  $('c-rain').textContent  = yes > no ? 'LIKELY RAIN' : 'LIKELY DRY';
  $('c-rain').style.color  = yes > no ? 'var(--cyan)' : 'var(--amber)';
  $('c-rain-sub').textContent = `${Math.max(yes,no)} / ${tot} models agree`;

  const norms = [[tSp,tHi],[pSp,35],[wSp,wHi]].filter(([v])=>v!=null).map(([v,h])=>v/h);
  const avgN  = norms.length ? norms.reduce((a,b)=>a+b,0)/norms.length : 1;
  const conf  = avgN<=0.4?'HIGH':avgN<=0.8?'MEDIUM':'LOW';
  $('c-conf').textContent  = conf;
  $('c-conf').className    = 'ci-value ' + (conf==='HIGH'?'spread-low':conf==='MEDIUM'?'spread-med':'spread-high');

  $('c-count').textContent = `${results.length} / ${MODELS.length}`;

  // Table body
  const tbody = $('tbody');
  tbody.innerHTML = '';
  results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <span class="td-model-name" style="color:${r.model.color}">${r.model.name}</span>
        <span class="td-model-origin">${r.model.origin}</span>
      </td>
      <td class="v-hi">${fmt(conv(r.high,'temp'),dT)}°</td>
      <td class="v-lo">${fmt(conv(r.low,'temp'),dT)}°</td>
      <td class="v-pr">${fmt(r.precipProb,0)}%</td>
      <td class="v-pr">${fmt(conv(r.precipSum,'precip'),2)}</td>
      <td class="v-wi">${fmt(conv(r.wind,'wind'),0)}</td>
      <td class="v-wi">${fmt(conv(r.gusts,'wind'),0)}</td>
      <td class="v-hu">${fmt(r.humidity,0)}%</td>
      <td class="v-cl">${fmt(r.cloud,0)}%</td>
      <td class="v-uv">${fmt(r.uv,1)}</td>
    `;
    tbody.appendChild(tr);
  });

  // Charts
  killCharts();
  const names  = results.map(r => r.model.name);
  const colors = results.map(r => r.model.color);

  // Temperature floating bar
  chartTemp = new Chart($('temp-chart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: names,
      datasets: [{
        label: `${tU} range`,
        data: results.map(r => [conv(r.low,'temp'), conv(r.high,'temp')]),
        backgroundColor: colors.map(c => c+'aa'),
        borderColor: colors,
        borderWidth: 1,
        borderRadius: 2,
      }]
    },
    options: {
      ...CBASE,
      plugins: {
        ...CBASE.plugins,
        tooltip: { ...CBASE.plugins.tooltip,
          callbacks: { label: ctx => ` Low: ${fmt(ctx.raw[0],dT)}${tU}  High: ${fmt(ctx.raw[1],dT)}${tU}` }
        }
      }
    }
  });

  // Precip probability
  chartPrecip = new Chart($('precip-chart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: names,
      datasets: [{
        label: 'Precip Probability',
        data: probs,
        backgroundColor: colors.map(c => c+'aa'),
        borderColor: colors,
        borderWidth: 1,
        borderRadius: 2,
      }]
    },
    options: { ...CBASE, scales: { ...CBASE.scales, y: { ...CBASE.scales.y, min:0, max:100 } } }
  });

  // Wind + gusts
  chartWind = new Chart($('wind-chart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: names,
      datasets: [
        {
          label: `Wind (${wU})`,
          data: results.map(r => conv(r.wind,'wind')),
          backgroundColor: '#3dd68c88', borderColor: '#3dd68c', borderWidth:1, borderRadius:2,
        },
        {
          label: `Gusts (${wU})`,
          data: results.map(r => conv(r.gusts,'wind')),
          backgroundColor: '#f2575766', borderColor: '#f25757', borderWidth:1, borderRadius:2,
        },
      ]
    },
    options: {
      ...CBASE,
      plugins: {
        ...CBASE.plugins,
        legend: {
          display: true,
          labels: { color:'#6a8099', font:{ family:"'Share Tech Mono', monospace", size:10 }, boxWidth:12 }
        }
      }
    }
  });

  $('results').classList.add('visible');
  if (window.innerWidth < 768) {
    setTimeout(() => $('results').scrollIntoView({ behavior:'smooth', block:'start' }), 100);
  }
}
</script>
</body>
</html>
