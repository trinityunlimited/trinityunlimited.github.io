<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeatherMatrix — Multi-Model Forecast Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0d12;
    --bg2: #0f1318;
    --bg3: #151b24;
    --panel: #111820;
    --border: #1e2d3d;
    --border2: #243447;
    --amber: #f0a500;
    --amber2: #ffc94d;
    --amber-dim: rgba(240,165,0,0.12);
    --cyan: #00d4e8;
    --cyan-dim: rgba(0,212,232,0.1);
    --green: #3dd68c;
    --red: #f25757;
    --blue: #4da6ff;
    --purple: #b97bff;
    --orange: #ff7b45;
    --text: #c8d8e8;
    --text-dim: #6a8099;
    --text-bright: #e8f4ff;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow Condensed', sans-serif;
    --glow: 0 0 20px rgba(240,165,0,0.2);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 16px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(30,45,61,0.3) 1px, transparent 1px),
      linear-gradient(90deg, rgba(30,45,61,0.3) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrap {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 20px 60px;
  }

  /* ── HEADER ── */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }

  .logo-mark {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--amber);
    letter-spacing: 0.15em;
    padding: 3px 8px;
    border: 1px solid var(--amber);
    border-radius: 2px;
    background: var(--amber-dim);
  }

  .logo h1 {
    font-family: var(--sans);
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--text-bright);
    line-height: 1;
  }

  .logo h1 span { color: var(--amber); }

  .header-right {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    line-height: 1.8;
  }

  .header-right .live { color: var(--green); }

  /* ── CONTROLS ── */
  .controls {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 12px;
    margin-bottom: 28px;
    align-items: end;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .field label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--amber);
    text-transform: uppercase;
  }

  .field input, .field select {
    background: var(--panel);
    border: 1px solid var(--border2);
    color: var(--text-bright);
    font-family: var(--sans);
    font-size: 17px;
    font-weight: 400;
    padding: 10px 14px;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }

  .field input:focus, .field select:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 2px rgba(240,165,0,0.12);
  }

  .field input::placeholder { color: var(--text-dim); }

  .field select option { background: var(--bg3); color: var(--text-bright); }

  .btn-fetch {
    background: var(--amber);
    color: #0a0d12;
    border: none;
    font-family: var(--sans);
    font-size: 17px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 10px 28px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    align-self: end;
  }

  .btn-fetch:hover { background: var(--amber2); }
  .btn-fetch:active { transform: scale(0.98); }
  .btn-fetch:disabled { background: #4a3d0a; color: #7a6a2a; cursor: not-allowed; }

  /* ── STATUS BAR ── */
  #status-bar {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-dim);
    padding: 8px 14px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 24px;
    min-height: 34px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #status-bar .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }
  #status-bar.loading .dot { background: var(--amber); animation: blink 0.8s infinite; }
  #status-bar.success .dot { background: var(--green); }
  #status-bar.error .dot { background: var(--red); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ── LOCATION SUGGESTIONS ── */
  .location-wrapper { position: relative; }

  #suggestions {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 4px;
    z-index: 100;
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }

  #suggestions.open { display: block; }

  .suggestion-item {
    padding: 9px 14px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border);
  }

  .suggestion-item:last-child { border-bottom: none; }
  .suggestion-item:hover { background: var(--border); }
  .suggestion-item .country { color: var(--text-dim); font-size: 13px; margin-left: 6px; }

  /* ── RESULTS ── */
  #results { display: none; }
  #results.visible { display: block; animation: fadeIn 0.4s ease; }

  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

  /* ── SUMMARY ROW ── */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 16px;
    position: relative;
    overflow: hidden;
  }

  .summary-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .summary-card.temp::before { background: var(--amber); }
  .summary-card.precip::before { background: var(--cyan); }
  .summary-card.wind::before { background: var(--green); }
  .summary-card.humidity::before { background: var(--blue); }
  .summary-card.cloud::before { background: var(--purple); }

  .summary-card .label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 0.2em;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .summary-card .value {
    font-family: var(--mono);
    font-size: 26px;
    font-weight: 400;
    color: var(--text-bright);
    line-height: 1;
  }

  .summary-card .range {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .summary-card .unit {
    font-size: 14px;
    color: var(--text-dim);
    margin-left: 2px;
  }

  /* ── CHARTS ── */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .chart-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 18px 20px;
  }

  .chart-panel h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .chart-container {
    position: relative;
    height: 220px;
  }

  /* ── DATA TABLE ── */
  .table-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 24px;
    overflow-x: auto;
  }

  .table-panel h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-transform: uppercase;
    margin-bottom: 16px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  thead th {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    text-transform: uppercase;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border2);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  tbody tr:hover { background: rgba(255,255,255,0.03); }
  tbody tr:last-child { border-bottom: none; }

  tbody td {
    padding: 10px 12px;
    white-space: nowrap;
  }

  .model-name {
    font-weight: 600;
    color: var(--text-bright);
    font-size: 15px;
  }

  .model-origin {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    display: block;
    margin-top: 1px;
  }

  .temp-high { color: var(--amber); font-family: var(--mono); font-size: 15px; }
  .temp-low { color: var(--cyan); font-family: var(--mono); font-size: 15px; }
  .precip-val { color: var(--blue); font-family: var(--mono); font-size: 15px; }
  .wind-val { color: var(--green); font-family: var(--mono); font-size: 15px; }
  .humidity-val { color: var(--purple); font-family: var(--mono); font-size: 15px; }
  .cloud-val { color: #aaa; font-family: var(--mono); font-size: 15px; }

  /* Consensus bar */
  .consensus-bar {
    background: var(--bg2);
    border-radius: 2px;
    height: 6px;
    width: 60px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
  }

  .consensus-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* ── CONSENSUS PANEL ── */
  .consensus-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .consensus-panel h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-transform: uppercase;
    margin-bottom: 16px;
  }

  .consensus-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }

  .consensus-item {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px 14px;
  }

  .consensus-item .ci-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    margin-bottom: 6px;
    text-transform: uppercase;
  }

  .consensus-item .ci-value {
    font-family: var(--mono);
    font-size: 22px;
    color: var(--text-bright);
  }

  .consensus-item .ci-spread {
    font-family: var(--mono);
    font-size: 11px;
    margin-top: 3px;
  }

  .spread-low { color: var(--green); }
  .spread-med { color: var(--amber); }
  .spread-high { color: var(--red); }

  /* ── HOURLY CHART ── */
  .full-chart-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .full-chart-panel h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--amber);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .full-chart-container {
    position: relative;
    height: 260px;
  }

  /* ── FOOTER ── */
  footer {
    border-top: 1px solid var(--border);
    padding-top: 20px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
  }

  footer p {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.7;
  }

  footer a { color: var(--amber); text-decoration: none; }

  .model-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-end;
  }

  .legend-tag {
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 2px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text-dim);
  }

  /* ── LOADING SKELETONS ── */
  .skeleton {
    background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
  }

  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  /* ── BADGE ── */
  .badge {
    display: inline-block;
    font-family: var(--mono);
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 2px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    vertical-align: middle;
    margin-left: 6px;
  }

  .badge-free { background: rgba(61,214,140,0.15); color: var(--green); border: 1px solid rgba(61,214,140,0.3); }

  /* ── RESPONSIVE ── */
  @media (max-width: 900px) {
    .summary-grid { grid-template-columns: repeat(3,1fr); }
    .charts-row { grid-template-columns: 1fr; }
    .consensus-grid { grid-template-columns: repeat(2,1fr); }
    .controls { grid-template-columns: 1fr 1fr; }
    .btn-fetch { grid-column: 1/-1; }
    header { flex-direction: column; align-items: flex-start; gap: 12px; }
  }

  @media (max-width: 560px) {
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .consensus-grid { grid-template-columns: 1fr; }
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-mark">v2.0</span>
      <h1>Weather<span>Matrix</span></h1>
    </div>
    <div class="header-right">
      <span class="live">● LIVE DATA</span> — OPEN METEOROLOGICAL MODELS<br>
      10+ INDEPENDENT FORECAST SOURCES — NO SIGN-UP REQUIRED<br>
      ECMWF · GFS · ICON · AROME · MET OFFICE · JMA · GEM · MORE
    </div>
  </header>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="field">
      <label>Location</label>
      <div class="location-wrapper">
        <input type="text" id="location-input" placeholder="City, region, or address…" autocomplete="off" spellcheck="false" />
        <div id="suggestions"></div>
      </div>
    </div>
    <div class="field">
      <label>Forecast Day</label>
      <select id="day-select"></select>
    </div>
    <button class="btn-fetch" id="fetch-btn" onclick="fetchAllModels()">
      RUN ANALYSIS
    </button>
  </div>

  <!-- STATUS BAR -->
  <div id="status-bar">
    <div class="dot"></div>
    <span id="status-text">Enter a location and select a day to begin forecast comparison.</span>
  </div>

  <!-- RESULTS -->
  <div id="results">

    <!-- SUMMARY CARDS -->
    <div class="summary-grid">
      <div class="summary-card temp">
        <div class="label">Avg High Temp</div>
        <div class="value" id="s-high">--<span class="unit">°C</span></div>
        <div class="range" id="s-high-range">Model range: --</div>
      </div>
      <div class="summary-card temp">
        <div class="label">Avg Low Temp</div>
        <div class="value" id="s-low">--<span class="unit">°C</span></div>
        <div class="range" id="s-low-range">Model range: --</div>
      </div>
      <div class="summary-card precip">
        <div class="label">Avg Precip Chance</div>
        <div class="value" id="s-precip">--<span class="unit">%</span></div>
        <div class="range" id="s-precip-range">Model range: --</div>
      </div>
      <div class="summary-card wind">
        <div class="label">Avg Wind Speed</div>
        <div class="value" id="s-wind">--<span class="unit">km/h</span></div>
        <div class="range" id="s-wind-range">Model range: --</div>
      </div>
      <div class="summary-card humidity">
        <div class="label">Avg Humidity</div>
        <div class="value" id="s-humidity">--<span class="unit">%</span></div>
        <div class="range" id="s-humidity-range">Model range: --</div>
      </div>
    </div>

    <!-- CONSENSUS PANEL -->
    <div class="consensus-panel">
      <h3>Model Consensus Analysis</h3>
      <div class="consensus-grid">
        <div class="consensus-item">
          <div class="ci-label">Temperature High Consensus</div>
          <div class="ci-value" id="c-temp-high">--°C</div>
          <div class="ci-spread" id="c-temp-high-spread">Spread: --</div>
        </div>
        <div class="consensus-item">
          <div class="ci-label">Precipitation Consensus</div>
          <div class="ci-value" id="c-precip">--%</div>
          <div class="ci-spread" id="c-precip-spread">Spread: --</div>
        </div>
        <div class="consensus-item">
          <div class="ci-label">Wind Speed Consensus</div>
          <div class="ci-value" id="c-wind">-- km/h</div>
          <div class="ci-spread" id="c-wind-spread">Spread: --</div>
        </div>
        <div class="consensus-item">
          <div class="ci-label">Rain Likelihood Vote</div>
          <div class="ci-value" id="c-rain-vote">--</div>
          <div class="ci-spread" id="c-rain-vote-spread">Models agree: --</div>
        </div>
        <div class="consensus-item">
          <div class="ci-label">Overall Confidence</div>
          <div class="ci-value" id="c-confidence">--</div>
          <div class="ci-spread" id="c-confidence-note">Based on spread across models</div>
        </div>
        <div class="consensus-item">
          <div class="ci-label">Models Returning Data</div>
          <div class="ci-value" id="c-model-count">0 / 10</div>
          <div class="ci-spread" id="c-model-note">Data sources active</div>
        </div>
      </div>
    </div>

    <!-- CHARTS ROW -->
    <div class="charts-row">
      <div class="chart-panel">
        <h3>Temperature Range by Model (°C)</h3>
        <div class="chart-container">
          <canvas id="temp-chart"></canvas>
        </div>
      </div>
      <div class="chart-panel">
        <h3>Precipitation Probability by Model (%)</h3>
        <div class="chart-container">
          <canvas id="precip-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- FULL WIDTH CHART -->
    <div class="full-chart-panel">
      <h3>Wind Speed & Humidity Comparison (all models)</h3>
      <div class="full-chart-container">
        <canvas id="wind-chart"></canvas>
      </div>
    </div>

    <!-- DATA TABLE -->
    <div class="table-panel">
      <h3>Full Data Table — All Models</h3>
      <table>
        <thead>
          <tr>
            <th>Model</th>
            <th>High °C</th>
            <th>Low °C</th>
            <th>Precip %</th>
            <th>Precip mm</th>
            <th>Wind km/h</th>
            <th>Gusts km/h</th>
            <th>Humidity %</th>
            <th>Cloud Cover %</th>
            <th>UV Index</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
        </tbody>
      </table>
    </div>

  </div><!-- /#results -->

  <!-- FOOTER -->
  <footer>
    <p>
      Data powered by <a href="https://open-meteo.com" target="_blank">Open-Meteo</a> — free, open-source weather API. <span class="badge badge-free">No API Key</span><br>
      Models: ECMWF IFS, NOAA GFS, DWD ICON, Météo-France AROME,<br>UK Met Office, JMA, Environment Canada GEM, KNMI, DMI, Best-Match Ensemble.
    </p>
    <div class="model-legend">
      <span class="legend-tag">ECMWF · EU</span>
      <span class="legend-tag">GFS · USA</span>
      <span class="legend-tag">ICON · DE</span>
      <span class="legend-tag">AROME · FR</span>
      <span class="legend-tag">MET · UK</span>
      <span class="legend-tag">JMA · JP</span>
      <span class="legend-tag">GEM · CA</span>
      <span class="legend-tag">KNMI · NL</span>
      <span class="legend-tag">DMI · DK</span>
      <span class="legend-tag">ENSEMBLE</span>
    </div>
  </footer>

</div><!-- /.wrap -->

<script>
// ──────────────────────────────────────────────
//  CONFIGURATION
// ──────────────────────────────────────────────
const MODELS = [
  { id: 'best_match',           name: 'Best-Match Ensemble', origin: 'Auto-selected best model' },
  { id: 'ecmwf_ifs04',          name: 'ECMWF IFS',           origin: 'European Centre (EU)' },
  { id: 'gfs_seamless',         name: 'NOAA GFS',            origin: 'National Weather Service (USA)' },
  { id: 'icon_seamless',        name: 'DWD ICON',            origin: 'Deutscher Wetterdienst (DE)' },
  { id: 'meteofrance_seamless', name: 'Météo-France AROME',  origin: 'Météo-France (FR)' },
  { id: 'ukmo_seamless',        name: 'UK Met Office',        origin: 'Met Office (UK)' },
  { id: 'jma_seamless',         name: 'JMA MSM',             origin: 'Japan Met Agency (JP)' },
  { id: 'gem_seamless',         name: 'Env. Canada GEM',     origin: 'Environment Canada (CA)' },
  { id: 'knmi_seamless',        name: 'KNMI HarmonIE',       origin: 'KNMI (NL)' },
  { id: 'dmi_seamless',         name: 'DMI HARMONIE',        origin: 'Danish Met Institute (DK)' },
];

const MODEL_COLORS = [
  '#f0a500','#00d4e8','#3dd68c','#4da6ff','#b97bff',
  '#ff7b45','#ff4d8b','#a8e063','#f25757','#5bc8f5',
];

// ──────────────────────────────────────────────
//  DAY SELECTOR INIT
// ──────────────────────────────────────────────
const daySelect = document.getElementById('day-select');
const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function initDaySelect() {
  daySelect.innerHTML = '';
  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() + i);
    const label = i === 0 ? `Today — ${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`
                : i === 1 ? `Tomorrow — ${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`
                : `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = label;
    daySelect.appendChild(opt);
  }
}
initDaySelect();

// ──────────────────────────────────────────────
//  GEOCODING
// ──────────────────────────────────────────────
let selectedLat = null, selectedLon = null, selectedLocationName = '';
let geoTimer = null;

const locationInput = document.getElementById('location-input');
const suggestionsEl = document.getElementById('suggestions');

locationInput.addEventListener('input', () => {
  clearTimeout(geoTimer);
  const val = locationInput.value.trim();
  if (val.length < 2) { suggestionsEl.classList.remove('open'); return; }
  geoTimer = setTimeout(() => searchLocation(val), 350);
});

locationInput.addEventListener('blur', () => {
  setTimeout(() => suggestionsEl.classList.remove('open'), 200);
});

async function searchLocation(q) {
  try {
    const resp = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=en&format=json`);
    const data = await resp.json();
    if (!data.results || data.results.length === 0) {
      suggestionsEl.classList.remove('open');
      return;
    }
    suggestionsEl.innerHTML = '';
    data.results.forEach(r => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.innerHTML = `<strong>${r.name}</strong><span class="country">${[r.admin1, r.country].filter(Boolean).join(', ')}</span>`;
      div.addEventListener('mousedown', () => {
        selectedLat = r.latitude;
        selectedLon = r.longitude;
        selectedLocationName = [r.name, r.admin1, r.country].filter(Boolean).join(', ');
        locationInput.value = selectedLocationName;
        suggestionsEl.classList.remove('open');
      });
      suggestionsEl.appendChild(div);
    });
    suggestionsEl.classList.add('open');
  } catch(e) {
    suggestionsEl.classList.remove('open');
  }
}

// ──────────────────────────────────────────────
//  STATUS
// ──────────────────────────────────────────────
function setStatus(msg, type='') {
  const bar = document.getElementById('status-bar');
  bar.className = type ? `${type}` : '';
  document.getElementById('status-text').textContent = msg;
}

// ──────────────────────────────────────────────
//  CHART INSTANCES
// ──────────────────────────────────────────────
let tempChart = null, precipChart = null, windChart = null;

function destroyCharts() {
  [tempChart, precipChart, windChart].forEach(c => c && c.destroy());
}

const CHART_DEFAULTS = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      display: false,
    },
    tooltip: {
      backgroundColor: '#0f1318',
      borderColor: '#1e2d3d',
      borderWidth: 1,
      titleColor: '#f0a500',
      bodyColor: '#c8d8e8',
      titleFont: { family: "'Share Tech Mono', monospace", size: 11 },
      bodyFont: { family: "'Barlow Condensed', sans-serif", size: 13 },
    }
  },
  scales: {
    x: {
      ticks: { color: '#6a8099', font: { family: "'Share Tech Mono', monospace", size: 10 } },
      grid: { color: 'rgba(30,45,61,0.6)' },
    },
    y: {
      ticks: { color: '#6a8099', font: { family: "'Share Tech Mono', monospace", size: 10 } },
      grid: { color: 'rgba(30,45,61,0.6)' },
    }
  }
};

// ──────────────────────────────────────────────
//  FETCH ALL MODELS
// ──────────────────────────────────────────────
async function fetchAllModels() {
  // Validate location
  if (!selectedLat || !selectedLon) {
    // Try to geocode whatever is in the input
    const val = locationInput.value.trim();
    if (!val) { setStatus('Please enter a location first.', 'error'); return; }
    try {
      setStatus('Resolving location…', 'loading');
      const resp = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=1&language=en&format=json`);
      const data = await resp.json();
      if (!data.results || data.results.length === 0) {
        setStatus(`Could not find location: "${val}". Try a different search term.`, 'error');
        return;
      }
      selectedLat = data.results[0].latitude;
      selectedLon = data.results[0].longitude;
      selectedLocationName = [data.results[0].name, data.results[0].admin1, data.results[0].country].filter(Boolean).join(', ');
      locationInput.value = selectedLocationName;
    } catch(e) {
      setStatus('Error resolving location. Check your connection.', 'error');
      return;
    }
  }

  const btn = document.getElementById('fetch-btn');
  btn.disabled = true;

  const dayOffset = parseInt(daySelect.value);
  const targetDate = new Date();
  targetDate.setDate(targetDate.getDate() + dayOffset);
  const dateStr = targetDate.toISOString().split('T')[0];

  setStatus(`Querying ${MODELS.length} forecast models for ${selectedLocationName}…`, 'loading');

  const results = [];
  let fetched = 0;

  const promises = MODELS.map(async (model, idx) => {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${selectedLat}&longitude=${selectedLon}`
        + `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,windspeed_10m_max,windgusts_10m_max,relativehumidity_2m_mean,cloudcover_mean,uv_index_max`
        + `&hourly=precipitation_probability,precipitation,windspeed_10m`
        + `&timezone=auto&models=${model.id}&forecast_days=7`;

      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.daily) throw new Error('No daily data');

      // Find index for our target date
      const dateIdx = data.daily.time.indexOf(dateStr);
      if (dateIdx === -1) throw new Error('Date not found');

      const row = {
        model: model,
        color: MODEL_COLORS[idx],
        high: data.daily.temperature_2m_max?.[dateIdx] ?? null,
        low: data.daily.temperature_2m_min?.[dateIdx] ?? null,
        precipProb: data.daily.precipitation_probability_max?.[dateIdx] ?? null,
        precipSum: data.daily.precipitation_sum?.[dateIdx] ?? null,
        wind: data.daily.windspeed_10m_max?.[dateIdx] ?? null,
        gusts: data.daily.windgusts_10m_max?.[dateIdx] ?? null,
        humidity: data.daily.relativehumidity_2m_mean?.[dateIdx] ?? null,
        cloud: data.daily.cloudcover_mean?.[dateIdx] ?? null,
        uv: data.daily.uv_index_max?.[dateIdx] ?? null,
      };

      results.push(row);
      fetched++;
      setStatus(`Fetched ${fetched}/${MODELS.length} models… (${model.name})`, 'loading');
    } catch(e) {
      // Silently skip failed models
      fetched++;
    }
  });

  await Promise.all(promises);

  btn.disabled = false;

  if (results.length === 0) {
    setStatus('All model requests failed. This location may be out of range for some models. Try a major city nearby.', 'error');
    return;
  }

  const d = targetDate;
  const dayLabel = dayOffset === 0 ? 'Today' : dayOffset === 1 ? 'Tomorrow' : `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
  setStatus(`✓ ${results.length}/${MODELS.length} models returned data for ${selectedLocationName} — ${dayLabel}`, 'success');

  renderResults(results);
}

// ──────────────────────────────────────────────
//  RENDER
// ──────────────────────────────────────────────
function avg(arr) { const v = arr.filter(x=>x!=null); return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null; }
function min(arr) { const v = arr.filter(x=>x!=null); return v.length ? Math.min(...v) : null; }
function max(arr) { const v = arr.filter(x=>x!=null); return v.length ? Math.max(...v) : null; }
function fmt(v, dec=1) { return v == null ? '—' : v.toFixed(dec); }
function spread(arr) { const mn=min(arr), mx=max(arr); return (mn==null||mx==null) ? null : mx-mn; }

function spreadClass(v, low, high) {
  if (v == null) return '';
  if (v <= low) return 'spread-low';
  if (v <= high) return 'spread-med';
  return 'spread-high';
}

function renderResults(results) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');

  const highs   = results.map(r=>r.high);
  const lows    = results.map(r=>r.low);
  const precips = results.map(r=>r.precipProb);
  const winds   = results.map(r=>r.wind);
  const hums    = results.map(r=>r.humidity);
  const clouds  = results.map(r=>r.cloud);

  // ── Summary Cards ──
  document.getElementById('s-high').innerHTML = `${fmt(avg(highs))}<span class="unit">°C</span>`;
  document.getElementById('s-high-range').textContent = `Model range: ${fmt(min(highs))}° – ${fmt(max(highs))}°`;
  document.getElementById('s-low').innerHTML = `${fmt(avg(lows))}<span class="unit">°C</span>`;
  document.getElementById('s-low-range').textContent = `Model range: ${fmt(min(lows))}° – ${fmt(max(lows))}°`;
  document.getElementById('s-precip').innerHTML = `${fmt(avg(precips),0)}<span class="unit">%</span>`;
  document.getElementById('s-precip-range').textContent = `Model range: ${fmt(min(precips),0)}% – ${fmt(max(precips),0)}%`;
  document.getElementById('s-wind').innerHTML = `${fmt(avg(winds),0)}<span class="unit">km/h</span>`;
  document.getElementById('s-wind-range').textContent = `Model range: ${fmt(min(winds),0)} – ${fmt(max(winds),0)} km/h`;
  document.getElementById('s-humidity').innerHTML = `${fmt(avg(hums),0)}<span class="unit">%</span>`;
  document.getElementById('s-humidity-range').textContent = `Model range: ${fmt(min(hums),0)}% – ${fmt(max(hums),0)}%`;

  // ── Consensus ──
  const tempSpread = spread(highs);
  document.getElementById('c-temp-high').textContent = `${fmt(avg(highs))}°C`;
  document.getElementById('c-temp-high-spread').innerHTML = `Spread: ${fmt(tempSpread,1)}°C <span class="${spreadClass(tempSpread,2,5)}">(${tempSpread<=2?'LOW':tempSpread<=5?'MEDIUM':'HIGH'})</span>`;

  const precipSpread = spread(precips);
  document.getElementById('c-precip').textContent = `${fmt(avg(precips),0)}%`;
  document.getElementById('c-precip-spread').innerHTML = `Spread: ${fmt(precipSpread,0)}% <span class="${spreadClass(precipSpread,15,35)}">(${precipSpread<=15?'LOW':precipSpread<=35?'MEDIUM':'HIGH'})</span>`;

  const windSpread = spread(winds);
  document.getElementById('c-wind').textContent = `${fmt(avg(winds),0)} km/h`;
  document.getElementById('c-wind-spread').innerHTML = `Spread: ${fmt(windSpread,0)} km/h <span class="${spreadClass(windSpread,10,25)}">(${windSpread<=10?'LOW':windSpread<=25?'MEDIUM':'HIGH'})</span>`;

  const rainYes = precips.filter(p=>p!=null&&p>=50).length;
  const rainNo  = precips.filter(p=>p!=null&&p<50).length;
  const total   = precips.filter(p=>p!=null).length;
  document.getElementById('c-rain-vote').textContent = rainYes > rainNo ? 'LIKELY RAIN' : 'LIKELY DRY';
  document.getElementById('c-rain-vote').style.color = rainYes > rainNo ? 'var(--cyan)' : 'var(--amber)';
  document.getElementById('c-rain-vote-spread').textContent = `${Math.max(rainYes,rainNo)}/${total} models agree`;

  const allSpreads = [tempSpread/5, precipSpread/35, windSpread/25].filter(x=>x!=null);
  const avgSpread = allSpreads.reduce((a,b)=>a+b,0)/allSpreads.length;
  const confidence = avgSpread <= 0.4 ? 'HIGH' : avgSpread <= 0.8 ? 'MEDIUM' : 'LOW';
  document.getElementById('c-confidence').textContent = confidence;
  document.getElementById('c-confidence').className = 'ci-value ' + (confidence==='HIGH'?'spread-low':confidence==='MEDIUM'?'spread-med':'spread-high');

  document.getElementById('c-model-count').textContent = `${results.length} / ${MODELS.length}`;

  // ── Data Table ──
  const tbody = document.getElementById('data-table-body');
  tbody.innerHTML = '';
  results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <span class="model-name" style="color:${r.color}">${r.model.name}</span>
        <span class="model-origin">${r.model.origin}</span>
      </td>
      <td class="temp-high">${fmt(r.high)}°</td>
      <td class="temp-low">${fmt(r.low)}°</td>
      <td class="precip-val">${fmt(r.precipProb,0)}%</td>
      <td class="precip-val">${fmt(r.precipSum)} mm</td>
      <td class="wind-val">${fmt(r.wind,0)}</td>
      <td class="wind-val">${fmt(r.gusts,0)}</td>
      <td class="humidity-val">${fmt(r.humidity,0)}%</td>
      <td class="cloud-val">${fmt(r.cloud,0)}%</td>
      <td style="font-family:var(--mono);font-size:15px;color:var(--orange)">${fmt(r.uv,1)}</td>
    `;
    tbody.appendChild(tr);
  });

  // ── Charts ──
  destroyCharts();
  const names = results.map(r => r.model.name.split(' ')[0]);
  const colors = results.map(r => r.color);

  // Temperature Range Chart (floating bar)
  const tempCtx = document.getElementById('temp-chart').getContext('2d');
  tempChart = new Chart(tempCtx, {
    type: 'bar',
    data: {
      labels: names,
      datasets: [
        {
          label: 'Low → High',
          data: results.map(r => [r.low, r.high]),
          backgroundColor: colors.map(c => c + 'aa'),
          borderColor: colors,
          borderWidth: 1,
          borderRadius: 2,
        }
      ]
    },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        tooltip: {
          ...CHART_DEFAULTS.plugins.tooltip,
          callbacks: {
            label: (ctx) => ` Low: ${ctx.raw[0]}°C  High: ${ctx.raw[1]}°C`
          }
        }
      },
      scales: {
        ...CHART_DEFAULTS.scales,
        y: {
          ...CHART_DEFAULTS.scales.y,
          title: { display: true, text: '°C', color: '#6a8099', font: { size: 10 } }
        }
      }
    }
  });

  // Precip Chart
  const precipCtx = document.getElementById('precip-chart').getContext('2d');
  precipChart = new Chart(precipCtx, {
    type: 'bar',
    data: {
      labels: names,
      datasets: [{
        label: 'Precip Probability',
        data: results.map(r => r.precipProb),
        backgroundColor: colors.map(c => c + 'aa'),
        borderColor: colors,
        borderWidth: 1,
        borderRadius: 2,
      }]
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        ...CHART_DEFAULTS.scales,
        y: {
          ...CHART_DEFAULTS.scales.y,
          min: 0, max: 100,
          title: { display: true, text: '%', color: '#6a8099', font: { size: 10 } }
        }
      }
    }
  });

  // Wind + Humidity Chart
  const windCtx = document.getElementById('wind-chart').getContext('2d');
  windChart = new Chart(windCtx, {
    type: 'bar',
    data: {
      labels: names,
      datasets: [
        {
          label: 'Wind Speed (km/h)',
          data: results.map(r => r.wind),
          backgroundColor: '#3dd68c88',
          borderColor: '#3dd68c',
          borderWidth: 1,
          borderRadius: 2,
          yAxisID: 'y',
        },
        {
          label: 'Gusts (km/h)',
          data: results.map(r => r.gusts),
          backgroundColor: '#f2575788',
          borderColor: '#f25757',
          borderWidth: 1,
          borderRadius: 2,
          yAxisID: 'y',
          type: 'bar',
        },
        {
          label: 'Humidity (%)',
          data: results.map(r => r.humidity),
          borderColor: '#4da6ff',
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.3,
          type: 'line',
          pointBackgroundColor: '#4da6ff',
          pointRadius: 4,
          yAxisID: 'y2',
        }
      ]
    },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        legend: {
          display: true,
          labels: {
            color: '#6a8099',
            font: { family: "'Share Tech Mono', monospace", size: 10 },
            boxWidth: 12,
          }
        }
      },
      scales: {
        ...CHART_DEFAULTS.scales,
        y: {
          ...CHART_DEFAULTS.scales.y,
          title: { display: true, text: 'km/h', color: '#6a8099', font: { size: 10 } },
          position: 'left',
        },
        y2: {
          ticks: { color: '#4da6ff', font: { family: "'Share Tech Mono', monospace", size: 10 } },
          grid: { display: false },
          title: { display: true, text: '%', color: '#4da6ff', font: { size: 10 } },
          position: 'right',
          min: 0, max: 100,
        }
      }
    }
  });

  // Scroll to results on mobile
  if (window.innerWidth < 768) {
    setTimeout(() => resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  }
}

// ──────────────────────────────────────────────
//  ENTER KEY SUPPORT
// ──────────────────────────────────────────────
locationInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { suggestionsEl.classList.remove('open'); fetchAllModels(); }
});
</script>
</body>
</html>
